<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Sprite Palette Remapper: LAB Edition</title>
    <style>
        :root { --bg: #1e1e1e; --panel: #252526; --border: #3e3e42; --accent: #007acc; --text: #d4d4d4; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; height: 100vh; margin: 0; display: flex; flex-direction: column; overflow: hidden; }
        
        header { background: var(--panel); padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 20px; flex-shrink: 0; }
        h1 { margin: 0; font-size: 18px; color: #fff; }
        a.back { color: #888; text-decoration: none; font-size: 20px; margin-right: 10px; }

        .main-container { display: flex; flex-grow: 1; overflow: hidden; }
        .column { padding: 20px; display: flex; flex-direction: column; border-right: 1px solid var(--border); overflow-y: auto; }
        .col-left { width: 250px; flex-shrink: 0; }
        .col-center { width: 340px; background: var(--panel); flex-shrink: 0; }
        .col-right { flex-grow: 1; background: #151515; }

        h2 { font-size: 13px; text-transform: uppercase; color: #888; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px; }
        
        .drop-zone { border: 2px dashed var(--border); border-radius: 6px; padding: 20px; text-align: center; cursor: pointer; transition: 0.2s; background: rgba(0,0,0,0.2); margin-bottom: 15px; font-size: 13px; color: #aaa; }
        .drop-zone:hover { border-color: var(--accent); background: rgba(0,122,204,0.1); }
        .source-item { font-size: 12px; padding: 5px; background: #333; border-radius: 3px; display: flex; justify-content: space-between; margin-bottom: 5px; }

        .result-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; padding-bottom: 50px; }
        .result-card { background: #252526; border: 1px solid #3e3e42; border-radius: 6px; overflow: hidden; transition: transform 0.1s; }
        .result-card:hover { transform: translateY(-2px); border-color: #666; }
        .card-img-wrap { height: 100px; background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAIklEQVQYV2NkYGRkYIAAdiGKQAQjI5QNJ2F0QZg441FCLwAAadQAwVqu1d4AAAAASUVORK5CYII='); display: flex; justify-content: center; align-items: center; cursor: zoom-in; }
        .card-img-wrap img { max-width: 100%; max-height: 100%; image-rendering: pixelated; }
        .card-footer { padding: 8px; display: flex; justify-content: space-between; align-items: center; background: #2d2d30; }
        .mini-btn { background: #444; color: white; border: none; border-radius: 3px; cursor: pointer; padding: 2px 6px; font-size: 12px; }

        .palette-preview { display: flex; flex-wrap: wrap; gap: 1px; margin-bottom: 20px; background: #000; padding: 2px; }
        .color-dot { width: 12px; height: 12px; }
        
        .control-group { margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; }
        .control-group label { display: block; margin-bottom: 5px; font-size: 12px; font-weight: 600; color: #ccc; }
        .sub-label { font-size: 10px; color: #888; margin-bottom: 5px; display: block; }
        input[type="range"] { width: 100%; margin-bottom: 5px; }
        
        button.btn-primary { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        button.btn-primary:hover { background: #0062a3; }
        button.btn-primary:disabled { background: #444; cursor: not-allowed; opacity: 0.5; }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #252526; width: 90vw; height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.8); border: 1px solid #444; border-radius: 8px; }
        .modal-header { padding: 10px 20px; background: #2d2d30; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; }
        .modal-body { flex: 1; display: flex; overflow: hidden; }
        .compare-pane { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #444; position: relative; }
        .pane-label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 12px; z-index: 10; pointer-events: none; }
        .image-container { flex: 1; overflow: hidden; background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAIklEQVQYV2NkYGRkYIAAdiGKQAQjI5QNJ2F0QZg441FCLwAAadQAwVqu1d4AAAAASUVORK5CYII='); cursor: grab; display: flex; justify-content: center; align-items: center; }
        .image-container img { image-rendering: pixelated; transform-origin: center; max-width: none; max-height: none; }
        .image-container:active { cursor: grabbing; }
        .modal-footer { padding: 10px 20px; background: #2d2d30; border-top: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="back">←</a>
        <h1>Sprite Palette Remapper (LAB Mode)</h1>
    </header>

    <div class="main-container">
        <div class="column col-left">
            <h2>1. Спрайты</h2>
            <div class="drop-zone" id="spriteDrop">+ Спрайты<input type="file" id="spriteInput" multiple accept="image/*" style="display:none"></div>
            <div class="sprite-list" id="sourceList"></div>
        </div>
        <div class="column col-center">
            <h2>2. Палитра</h2>
            <div class="drop-zone" id="paletteDrop" style="padding:10px;">+ Палитра<input type="file" id="paletteInput" accept="image/*" style="display:none"></div>
            <div id="paletteInfo" style="display:none">
                <div class="palette-preview" id="palettePreview"></div>
                <div style="font-size:11px; color:#888;">Цветов: <span id="colorCount">0</span></div>
            </div>
            
            <h2>3. Алгоритм</h2>
            
            <div class="control-group">
                <label>Метод сравнения:</label>
                <select id="colorMode" style="width:100%; background:#333; color:#fff; border:1px solid #555; padding:5px;">
                    <option value="lab">LAB (Человеческий глаз) - Рекомендую</option>
                    <option value="rgb">RGB (Математический) - Старый метод</option>
                </select>
            </div>

            <div class="control-group">
                <label>Приоритет яркости: <span id="lumaVal">50%</span></label>
                <span class="sub-label">0% = Важен только цвет | 100% = Важна только яркость</span>
                <input type="range" id="lumaWeight" min="0" max="2" step="0.1" value="1" oninput="updateLabels()">
            </div>

            <div class="control-group">
                <label>Сила эффекта (Mix): <span id="strengthVal">100%</span></label>
                <input type="range" id="strength" min="0" max="1" step="0.05" value="1" oninput="updateLabels()">
            </div>

            <div class="control-group">
                <label style="cursor:pointer; display:flex; align-items:center;"><input type="checkbox" id="dithering" style="margin-right:8px;"> Дизеринг (Шум)</label>
                <label style="cursor:pointer; display:flex; align-items:center; margin-top:5px;"><input type="checkbox" id="preserveAlpha" checked style="margin-right:8px;"> Сохранять прозрачность оригинала</label>
            </div>

            <button class="btn-primary" id="processBtn" onclick="processAll()" disabled>ОБРАБОТАТЬ</button>
            <button onclick="downloadAll()" id="downloadAllBtn" style="width:100%; margin-top:10px; padding:10px; background:#333; border:1px solid #555; color:#ddd; border-radius:4px; cursor:pointer; display:none;">Скачать ZIP</button>
        </div>
        <div class="column col-right">
            <h2>Результат</h2>
            <div class="result-grid" id="resultGrid"></div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; font-size:16px" id="modalTitle">Просмотр</h3>
                <button onclick="closeModal()" style="background:none;border:none;color:#fff;font-size:24px;cursor:pointer;">×</button>
            </div>
            <div class="modal-body">
                <div class="compare-pane">
                    <div class="pane-label">Оригинал</div>
                    <div class="image-container" id="containerOrig"><img id="modalOriginal" draggable="false"></div>
                </div>
                <div class="compare-pane">
                    <div class="pane-label">Результат</div>
                    <div class="image-container" id="containerRes"><img id="modalResult" draggable="false"></div>
                </div>
            </div>
            <div class="modal-footer">
                <div>Зум: <input type="range" id="zoomRange" min="0.1" max="10" step="0.1" value="1" style="width:100px"></div>
                <button class="btn-primary" style="width:auto; padding:8px 30px;" onclick="downloadFromModal()">Скачать</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        let sourceImages = [], paletteColors = [], processedData = {};

        // --- Color Conversion Utilities (RGB <-> LAB) ---
        function rgb2lab(r, g, b) {
            let r_ = r / 255, g_ = g / 255, b_ = b / 255;
            if (r_ > 0.04045) r_ = Math.pow((r_ + 0.055) / 1.055, 2.4); else r_ = r_ / 12.92;
            if (g_ > 0.04045) g_ = Math.pow((g_ + 0.055) / 1.055, 2.4); else g_ = g_ / 12.92;
            if (b_ > 0.04045) b_ = Math.pow((b_ + 0.055) / 1.055, 2.4); else b_ = b_ / 12.92;
            let x = (r_ * 0.4124 + g_ * 0.3576 + b_ * 0.1805) / 0.95047;
            let y = (r_ * 0.2126 + g_ * 0.7152 + b_ * 0.0722) / 1.00000;
            let z = (r_ * 0.0193 + g_ * 0.1192 + b_ * 0.9505) / 1.08883;
            if (x > 0.008856) x = Math.pow(x, 1/3); else x = (7.787 * x) + 16/116;
            if (y > 0.008856) y = Math.pow(y, 1/3); else y = (7.787 * y) + 16/116;
            if (z > 0.008856) z = Math.pow(z, 1/3); else z = (7.787 * z) + 16/116;
            return { l: (116 * y) - 16, a: 500 * (x - y), b: 200 * (y - z) };
        }

        // --- UI Setup ---
        function setupDrop(elem, input, callback) {
            elem.addEventListener('click', () => input.click());
            input.addEventListener('change', e => handleFiles(e.target.files, callback));
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => { elem.addEventListener(e, ev => ev.preventDefault()); });
            elem.addEventListener('drop', e => { e.preventDefault(); handleFiles(e.dataTransfer.files, callback); });
        }
        function handleFiles(files, callback) {
            Array.from(files).forEach(file => {
                if(!file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => callback(img, file.name);
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        setupDrop(document.getElementById('spriteDrop'), document.getElementById('spriteInput'), (img, name) => {
            sourceImages.push({ img, name });
            const list = document.getElementById('sourceList');
            if(sourceImages.length===1) list.innerHTML='';
            list.innerHTML += `<div class="source-item"><span>${name}</span><span>${img.width}x${img.height}</span></div>`;
            checkReady();
        });
        setupDrop(document.getElementById('paletteDrop'), document.getElementById('paletteInput'), (img) => {
            const c = document.createElement('canvas'); const ctx = c.getContext('2d');
            c.width = img.width; c.height = img.height; ctx.drawImage(img, 0, 0);
            const data = ctx.getImageData(0,0,c.width,c.height).data;
            const unique = new Set(); paletteColors = [];
            for(let i=0; i<data.length; i+=4) {
                if(data[i+3]<10) continue;
                const k = `${data[i]},${data[i+1]},${data[i+2]}`;
                if(!unique.has(k)) { 
                    unique.add(k); 
                    const lab = rgb2lab(data[i], data[i+1], data[i+2]);
                    paletteColors.push({r:data[i], g:data[i+1], b:data[i+2], lab: lab}); 
                }
            }
            document.getElementById('palettePreview').innerHTML = paletteColors.slice(0,100).map(c=>`<div class="color-dot" style="background:rgb(${c.r},${c.g},${c.b})"></div>`).join('');
            document.getElementById('colorCount').innerText = paletteColors.length;
            document.getElementById('paletteInfo').style.display = 'block';
            checkReady();
        });
        
        function checkReady() { document.getElementById('processBtn').disabled = !(sourceImages.length && paletteColors.length); }
        function updateLabels() { 
            document.getElementById('strengthVal').innerText = Math.round(document.getElementById('strength').value * 100) + '%'; 
            document.getElementById('lumaVal').innerText = document.getElementById('lumaWeight').value; 
        }

        // --- CORE PROCESSING ---
        function processAll() {
            const grid = document.getElementById('resultGrid');
            grid.innerHTML = '<div style="color:#888; padding:20px;">Обработка...</div>';
            processedData = {};
            
            const strength = parseFloat(document.getElementById('strength').value);
            const lumaWeight = parseFloat(document.getElementById('lumaWeight').value);
            const useLab = document.getElementById('colorMode').value === 'lab';
            const useDither = document.getElementById('dithering').checked;
            const preserveAlpha = document.getElementById('preserveAlpha').checked;

            setTimeout(() => {
                grid.innerHTML = '';
                sourceImages.forEach(src => {
                    const c = document.createElement('canvas'); c.width = src.img.width; c.height = src.img.height;
                    const ctx = c.getContext('2d'); ctx.drawImage(src.img, 0, 0);
                    const data = ctx.getImageData(0,0,c.width,c.height).data;

                    for(let i=0; i<data.length; i+=4) {
                        if(data[i+3]<10) continue; // Skip transparency

                        const curR = data[i], curG = data[i+1], curB = data[i+2];
                        let curLab = null;
                        if(useLab) curLab = rgb2lab(curR, curG, curB);

                        let best = paletteColors[0];
                        let minDist = Infinity;

                        for(const p of paletteColors) {
                            let dist = 0;
                            if(useLab) {
                                // LAB Distance with weighted Luminance (L)
                                // d = sqrt( (w*(L1-L2))^2 + (a1-a2)^2 + (b1-b2)^2 )
                                const dL = (curLab.l - p.lab.l) * lumaWeight; 
                                const da = (curLab.a - p.lab.a);
                                const db = (curLab.b - p.lab.b);
                                dist = dL*dL + da*da + db*db;
                            } else {
                                // Simple RGB
                                dist = (curR-p.r)**2 + (curG-p.g)**2 + (curB-p.b)**2;
                            }

                            if(dist < minDist) { minDist = dist; best = p; }
                        }

                        // Mixing
                        data[i] = curR*(1-strength) + best.r*strength;
                        data[i+1] = curG*(1-strength) + best.g*strength;
                        data[i+2] = curB*(1-strength) + best.b*strength;
                        // Alpha handling: keep original if "preserveAlpha" checked
                        if(!preserveAlpha) data[i+3] = 255; 

                        // Dither (Simple)
                        if(useDither && strength > 0.8) {
                            const er = (curR - best.r)*strength;
                            const eg = (curG - best.g)*strength;
                            const eb = (curB - best.b)*strength;
                            // Just diff to neighbor
                            if(i+4 < data.length) {
                                data[i+4] = Math.min(255, Math.max(0, data[i+4] + er*0.5));
                                data[i+5] = Math.min(255, Math.max(0, data[i+5] + eg*0.5));
                                data[i+6] = Math.min(255, Math.max(0, data[i+6] + eb*0.5));
                            }
                        }
                    }
                    ctx.putImageData(new ImageData(data, c.width, c.height), 0, 0);
                    c.toBlob(blob => {
                        processedData[src.name] = blob;
                        const url = URL.createObjectURL(blob);
                        grid.innerHTML += `<div class="result-card">
                            <div class="card-img-wrap" onclick="openModal('${src.name}', '${src.img.src}', '${url}', ${src.img.width})"><img src="${url}"></div>
                            <div class="card-footer"><button class="mini-btn" onclick="downloadSingle('${src.name}')">Скачать</button></div>
                        </div>`;
                    });
                });
                document.getElementById('downloadAllBtn').style.display = 'block';
            }, 50);
        }

        // --- Modal & Download Utils ---
        function downloadSingle(name) { const a = document.createElement('a'); a.href = URL.createObjectURL(processedData[name]); a.download = "remap_"+name; a.click(); }
        function downloadAll() { const zip = new JSZip(); for(const [n, b] of Object.entries(processedData)) zip.file("remap_"+n, b); zip.generateAsync({type:"blob"}).then(c=>{const a=document.createElement('a'); a.href=URL.createObjectURL(c); a.download="remapped.zip"; a.click();}); }
        
        // Modal Logic
        let currentModalName='', scale=1, isDragging=false, startX=0, startY=0, transX=0, transY=0;
        const modal = document.getElementById('previewModal');
        const imgOrig = document.getElementById('modalOriginal');
        const imgRes = document.getElementById('modalResult');
        const zoomRange = document.getElementById('zoomRange');

        function openModal(name, src1, src2, w) {
            currentModalName=name; document.getElementById('modalTitle').innerText=name;
            imgOrig.src=src1; imgRes.src=src2;
            scale = w < 128 ? 4 : 1; zoomRange.value=scale; updateTransform();
            modal.style.display='flex';
        }
        function closeModal() { modal.style.display='none'; transX=0; transY=0; }
        function downloadFromModal() { if(currentModalName) downloadSingle(currentModalName); }
        
        zoomRange.addEventListener('input', e=>{ scale=e.target.value; updateTransform(); });
        function updateTransform() { const t=`translate(${transX}px,${transY}px) scale(${scale})`; imgOrig.style.transform=t; imgRes.style.transform=t; }
        
        [document.getElementById('containerOrig'), document.getElementById('containerRes')].forEach(el=>{
            el.addEventListener('mousedown', e=>{ isDragging=true; startX=e.clientX-transX; startY=e.clientY-transY; });
            window.addEventListener('mousemove', e=>{ if(!isDragging)return; e.preventDefault(); transX=e.clientX-startX; transY=e.clientY-startY; updateTransform(); });
            window.addEventListener('mouseup', ()=>isDragging=false);
        });
    </script>
</body>
</html>
