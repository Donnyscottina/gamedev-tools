<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Sprite Palette Remapper</title>
    <style>
        :root {
            --bg: #1e1e1e;
            --panel: #252526;
            --border: #3e3e42;
            --accent: #007acc;
            --text: #d4d4d4;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; height: 100vh; margin: 0; display: flex; flex-direction: column; }
        
        header { background: var(--panel); padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 20px; }
        h1 { margin: 0; font-size: 18px; color: #fff; }
        a.back { color: #888; text-decoration: none; font-size: 20px; margin-right: 10px; }

        .main-container { display: flex; flex-grow: 1; overflow: hidden; }
        
        /* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ò—Å—Ö–æ–¥–Ω–∏–∫–∏ */
        .column { flex: 1; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid var(--border); overflow-y: auto; }
        .column h2 { font-size: 14px; text-transform: uppercase; color: #888; margin-top: 0; }
        
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            background: rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--accent); background: rgba(0,122,204,0.1); }
        
        /* –°–µ—Ç–∫–∞ —Å–ø—Ä–∞–π—Ç–æ–≤ */
        .sprite-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
        .sprite-card { background: #333; padding: 5px; border-radius: 4px; text-align: center; position: relative; }
        .sprite-card img { max-width: 100%; height: auto; image-rendering: pixelated; }
        .sprite-card .name { font-size: 10px; color: #aaa; margin-top: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ü–∞–ª–∏—Ç—Ä–∞ */
        .controls { width: 300px; background: var(--panel); padding: 20px; display: flex; flex-direction: column; gap: 20px; border-right: 1px solid var(--border); flex-shrink: 0; }
        
        .palette-preview {
            display: flex; flex-wrap: wrap; gap: 2px; margin-top: 10px;
            background: #000; padding: 5px; border-radius: 4px; min-height: 20px;
        }
        .color-dot { width: 16px; height: 16px; border: 1px solid #555; }
        
        .palette-source-img { max-width: 100%; max-height: 100px; margin-top: 5px; border: 1px solid #555; display: none; }

        button.btn-primary { 
            background: var(--accent); color: white; border: none; padding: 12px; 
            border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; font-size: 14px; 
        }
        button.btn-primary:hover { background: #0062a3; }
        button.btn-primary:disabled { background: #444; cursor: not-allowed; opacity: 0.7; }

        /* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –†–µ–∑—É–ª—å—Ç–∞—Ç */
        .result-column { flex: 1; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; background: #151515; }
        
        .compare-view { display: flex; gap: 5px; justify-content: center; margin-bottom: 10px; }
        .compare-img { border: 1px solid #444; background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAIklEQVQYV2NkYGRkYIAAdiGKQAQjI5QNJ2F0QZg441FCLwAAadQAwVqu1d4AAAAASUVORK5CYII='); }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="back">‚Üê</a>
        <h1>Sprite Palette Remapper</h1>
    </header>

    <div class="main-container">
        <!-- 1. –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã -->
        <div class="column">
            <h2>1. –ó–∞–≥—Ä—É–∑–∏ —Å–ø—Ä–∞–π—Ç—ã</h2>
            <div class="drop-zone" id="spriteDrop">
                –ü–µ—Ä–µ—Ç–∞—â–∏ —Å—é–¥–∞ –ø–∞–ø–∫—É —Å–æ —Å–ø—Ä–∞–π—Ç–∞–º–∏<br>–∏–ª–∏ –∫–ª–∏–∫–Ω–∏
                <input type="file" id="spriteInput" multiple accept="image/*" style="display:none">
            </div>
            <div class="sprite-grid" id="sourceGrid"></div>
        </div>

        <!-- 2. –ü–∞–ª–∏—Ç—Ä–∞ -->
        <div class="controls">
            <h2>2. –ó–∞–≥—Ä—É–∑–∏ –ü–∞–ª–∏—Ç—Ä—É</h2>
            <div class="drop-zone" id="paletteDrop" style="padding: 10px; font-size: 13px;">
                –ü–µ—Ä–µ—Ç–∞—â–∏ —Å—é–¥–∞ PNG/JPG —Å –ø–∞–ª–∏—Ç—Ä–æ–π<br>(–≥—Ä–∞–¥–∏–µ–Ω—Ç, —Ç–∞–±–ª–∏—Ü–∞ —Ü–≤–µ—Ç–æ–≤)
                <input type="file" id="paletteInput" accept="image/*" style="display:none">
            </div>
            <img id="paletteSourceImg" class="palette-source-img">
            
            <div>
                <span style="font-size:12px; color:#888">–ù–∞–π–¥–µ–Ω–æ —Ü–≤–µ—Ç–æ–≤: <b id="colorCount">0</b></span>
                <div class="palette-preview" id="palettePreview"></div>
            </div>

            <div style="margin-top:auto">
                <h2>3. –û–±—Ä–∞–±–æ—Ç–∫–∞</h2>
                <label style="display:block; margin-bottom:10px; font-size:13px; cursor:pointer;">
                    <input type="checkbox" id="dithering"> –î–∏–∑–µ—Ä–∏–Ω–≥ (–®—É–º)
                    <span style="color:#666; font-size:11px; display:block">–ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤</span>
                </label>
                <button class="btn-primary" id="processBtn" onclick="processAll()" disabled>–†–ï–ú–ê–ü–ü–ò–ù–ì üöÄ</button>
            </div>
        </div>

        <!-- 3. –†–µ–∑—É–ª—å—Ç–∞—Ç -->
        <div class="result-column">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
                <button onclick="downloadAll()" id="downloadBtn" style="background:#333; color:white; border:1px solid #555; padding:5px 10px; border-radius:3px; cursor:pointer; display:none;">–°–∫–∞—á–∞—Ç—å –≤—Å—ë (ZIP)</button>
            </div>
            <div class="sprite-grid" id="resultGrid"></div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º JSZip –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–æ–º -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let sourceImages = []; // { name, img }
        let paletteColors = []; // [{r,g,b}, ...]
        let processedImages = []; // { name, blob }

        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const spriteDrop = document.getElementById('spriteDrop');
        const spriteInput = document.getElementById('spriteInput');
        const paletteDrop = document.getElementById('paletteDrop');
        const paletteInput = document.getElementById('paletteInput');
        
        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Drag & Drop ---
        function setupDrop(elem, input, callback) {
            elem.addEventListener('click', () => input.click());
            input.addEventListener('change', e => handleFiles(e.target.files, callback));
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                elem.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
            });
            elem.addEventListener('dragenter', () => elem.classList.add('dragover'));
            elem.addEventListener('dragleave', () => elem.classList.remove('dragover'));
            elem.addEventListener('drop', e => {
                elem.classList.remove('dragover');
                handleFiles(e.dataTransfer.files, callback);
            });
        }

        setupDrop(spriteDrop, spriteInput, loadSprites);
        setupDrop(paletteDrop, paletteInput, loadPalette);

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –°–ø—Ä–∞–π—Ç–æ–≤ ---
        function handleFiles(files, callback) {
            Array.from(files).forEach(file => {
                if(!file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => callback(img, file.name);
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function loadSprites(img, name) {
            sourceImages.push({ img, name });
            renderSourceGrid();
            checkReady();
        }

        function renderSourceGrid() {
            const grid = document.getElementById('sourceGrid');
            grid.innerHTML = sourceImages.map((s, i) => `
                <div class="sprite-card">
                    <img src="${s.img.src}">
                    <div class="name">${s.name}</div>
                </div>
            `).join('');
        }

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ê–Ω–∞–ª–∏–∑ –ü–∞–ª–∏—Ç—Ä—ã ---
        function loadPalette(img, name) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –∫–∞—Ä—Ç–∏–Ω–∫–∏-–ø–∞–ª–∏—Ç—Ä—ã
            const preview = document.getElementById('paletteSourceImg');
            preview.src = img.src;
            preview.style.display = 'block';

            // –ò–∑–≤–ª–µ–∫–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            const uniqueColors = new Set();
            paletteColors = [];

            for(let i=0; i<data.length; i+=4) {
                if(data[i+3] < 128) continue; // –ò–≥–Ω–æ—Ä –ø—Ä–æ–∑—Ä–∞—á–Ω—ã—Ö
                const r=data[i], g=data[i+1], b=data[i+2];
                const key = `${r},${g},${b}`;
                if(!uniqueColors.has(key)) {
                    uniqueColors.add(key);
                    paletteColors.push({r, g, b});
                }
            }
            
            // –ï—Å–ª–∏ —Ü–≤–µ—Ç–æ–≤ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ (>256), –º–æ–∂–Ω–æ –±—ã —Å–æ–∫—Ä–∞—Ç–∏—Ç—å, –Ω–æ –ø–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –µ—Å—Ç—å
            document.getElementById('colorCount').innerText = paletteColors.length;
            renderPaletteColors();
            checkReady();
        }

        function renderPaletteColors() {
            const container = document.getElementById('palettePreview');
            // –û–≥—Ä–∞–Ω–∏—á–∏–º –≤—ã–≤–æ–¥ 100 —Ü–≤–µ—Ç–∞–º–∏ –¥–ª—è UI, —á—Ç–æ–±—ã –Ω–µ —Ç–æ—Ä–º–æ–∑–∏–ª–æ
            const showColors = paletteColors.slice(0, 200);
            container.innerHTML = showColors.map(c => 
                `<div class="color-dot" style="background:rgb(${c.r},${c.g},${c.b})"></div>`
            ).join('');
        }

        function checkReady() {
            document.getElementById('processBtn').disabled = !(sourceImages.length > 0 && paletteColors.length > 0);
        }

        // --- –ê–ª–≥–æ—Ä–∏—Ç–º –†–µ–º–∞–ø–ø–∏–Ω–≥–∞ ---
        function processAll() {
            const resultGrid = document.getElementById('resultGrid');
            resultGrid.innerHTML = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            processedImages = [];
            const useDither = document.getElementById('dithering').checked;

            setTimeout(() => { // –î–∞–µ–º UI –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
                resultGrid.innerHTML = '';
                
                sourceImages.forEach(srcItem => {
                    const canvas = document.createElement('canvas');
                    canvas.width = srcItem.img.width;
                    canvas.height = srcItem.img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(srcItem.img, 0, 0);

                    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imgData.data;

                    for(let i=0; i<data.length; i+=4) {
                        if(data[i+3] < 10) continue; // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –Ω–µ —Ç—Ä–æ–≥–∞–µ–º

                        const current = {r: data[i], g: data[i+1], b: data[i+2]};
                        
                        // –ò—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π —Ü–≤–µ—Ç (Euclidean distance)
                        let minDist = Infinity;
                        let best = paletteColors[0];

                        for(const p of paletteColors) {
                            // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è. –î–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Lab, –Ω–æ RGB –±—ã—Å—Ç—Ä–µ–µ
                            const dist = (current.r - p.r)**2 + (current.g - p.g)**2 + (current.b - p.b)**2;
                            if(dist < minDist) {
                                minDist = dist;
                                best = p;
                            }
                        }

                        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç
                        data[i] = best.r;
                        data[i+1] = best.g;
                        data[i+2] = best.b;
                        
                        // –ü—Ä–æ—Å—Ç–µ–π—à–∏–π Floyd-Steinberg Dithering (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)
                        if(useDither) {
                            const errR = current.r - best.r;
                            const errG = current.g - best.g;
                            const errB = current.b - best.b;
                            
                            distributeError(data, i, errR, errG, errB, canvas.width);
                        }
                    }

                    ctx.putImageData(imgData, 0, 0);

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    canvas.toBlob(blob => {
                        const url = URL.createObjectURL(blob);
                        processedImages.push({ name: srcItem.name, blob });
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤ UI
                        const card = document.createElement('div');
                        card.className = 'sprite-card';
                        card.innerHTML = `
                            <div class="compare-view">
                                <img src="${url}" class="compare-img">
                            </div>
                            <div class="name">${srcItem.name}</div>
                        `;
                        resultGrid.appendChild(card);
                    }, 'image/png');
                });
                
                document.getElementById('downloadBtn').style.display = 'block';

            }, 50);
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –¥–ª—è –¥–∏–∑–µ—Ä–∏–Ω–≥–∞
        function distributeError(data, idx, er, eg, eb, w) {
            // –°–æ—Å–µ–¥ —Å–ø—Ä–∞–≤–∞ (idx + 4) += 7/16
            // –°–æ—Å–µ–¥ —Å–Ω–∏–∑—É-—Å–ª–µ–≤–∞ (idx + w*4 - 4) += 3/16
            // –°–æ—Å–µ–¥ —Å–Ω–∏–∑—É (idx + w*4) += 5/16
            // –°–æ—Å–µ–¥ —Å–Ω–∏–∑—É-—Å–ø—Ä–∞–≤–∞ (idx + w*4 + 4) += 1/16
            // –ü—Ä–æ–≤–µ—Ä–∫–∏ –≥—Ä–∞–Ω–∏—Ü –º–∞—Å—Å–∏–≤–∞ –æ–ø—É—Å—Ç–∏–º –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ (JS undefined –Ω–µ –∫—Ä–∞—à–∏—Ç, –ø—Ä–æ—Å—Ç–æ NaN –≤ –ø–∏–∫—Å–µ–ª—è—Ö –±—É–¥–µ—Ç, —á—Ç–æ –ø–æ—Ñ–∏–≥)
            const addErr = (i, f) => {
                if(i < data.length) {
                    data[i] += er * f;
                    data[i+1] += eg * f;
                    data[i+2] += eb * f;
                }
            };
            
            addErr(idx + 4, 7/16);
            addErr(idx + w*4 - 4, 3/16);
            addErr(idx + w*4, 5/16);
            addErr(idx + w*4 + 4, 1/16);
        }

        // --- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ ---
        function downloadAll() {
            if(processedImages.length === 0) return;
            
            const zip = new JSZip();
            const folder = zip.folder("remapped_sprites");
            
            processedImages.forEach(item => {
                folder.file(item.name, item.blob);
            });
            
            zip.generateAsync({type:"blob"}).then(function(content) {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = "remapped_sprites.zip";
                link.click();
            });
        }
    </script>
</body>
</html>
