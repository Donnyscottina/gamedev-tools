<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Multi-Palette Studio</title>
    <style>
        :root { --bg: #1e1e1e; --panel: #252526; --border: #3e3e42; --accent: #007acc; --text: #d4d4d4; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; height: 100vh; margin: 0; display: flex; flex-direction: column; overflow: hidden; }
        
        header { background: var(--panel); padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 20px; flex-shrink: 0; }
        h1 { margin: 0; font-size: 18px; color: #fff; }
        a.back { color: #888; text-decoration: none; font-size: 20px; margin-right: 10px; }

        .main-container { display: flex; flex-grow: 1; overflow: hidden; }
        .column { padding: 20px; display: flex; flex-direction: column; border-right: 1px solid var(--border); overflow-y: auto; }
        .col-left { width: 250px; flex-shrink: 0; }
        .col-center { width: 340px; background: var(--panel); flex-shrink: 0; }
        .col-right { flex-grow: 1; background: #151515; }

        h2 { font-size: 13px; text-transform: uppercase; color: #888; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px; }
        
        /* Drop Zones */
        .drop-zone { border: 2px dashed var(--border); border-radius: 6px; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; background: rgba(0,0,0,0.2); margin-bottom: 15px; font-size: 13px; color: #aaa; }
        .drop-zone:hover { border-color: var(--accent); background: rgba(0,122,204,0.1); }
        .source-item { font-size: 12px; padding: 5px; background: #333; border-radius: 3px; display: flex; justify-content: space-between; margin-bottom: 5px; }

        /* Palette Manager */
        .palette-list { margin-bottom: 15px; display: flex; flex-direction: column; gap: 8px; }
        .palette-item { background: #333; border: 1px solid #444; border-radius: 4px; padding: 8px; }
        .palette-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .palette-name { font-size: 12px; font-weight: bold; color: #fff; }
        .palette-remove { color: #ff5555; cursor: pointer; font-size: 14px; padding: 0 4px; }
        .palette-preview-strip { display: flex; height: 8px; border-radius: 2px; overflow: hidden; }
        .color-slice { flex: 1; }

        /* Result Rows */
        .result-row { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: #fff; font-size: 14px; font-weight: bold; }
        .row-scroller { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        
        /* Interactive Cards */
        .result-card { background: #252526; border: 1px solid #3e3e42; border-radius: 6px; overflow: hidden; min-width: 100px; width: 100px; flex-shrink: 0; cursor: pointer; transition: transform 0.1s, border-color 0.1s; position: relative; }
        .result-card:hover { transform: translateY(-3px); border-color: var(--accent); z-index: 10; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .result-card:active { transform: translateY(-1px); }
        
        .card-header { font-size: 10px; color: #888; padding: 4px; text-align: center; background: #202020; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .card-img-wrap { height: 80px; background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAIklEQVQYV2NkYGRkYIAAdiGKQAQjI5QNJ2F0QZg441FCLwAAadQAwVqu1d4AAAAASUVORK5CYII='); display: flex; justify-content: center; align-items: center; }
        .card-img-wrap img { max-width: 100%; max-height: 100%; image-rendering: pixelated; pointer-events: none; }
        
        /* Overlay icon on hover */
        .result-card::after { content: 'üîç'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; opacity: 0; transition: 0.2s; pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .result-card:hover::after { opacity: 1; }

        /* Controls */
        .control-group { margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; }
        .control-group label { display: block; margin-bottom: 5px; font-size: 12px; font-weight: 600; color: #ccc; }
        input[type="range"] { width: 100%; margin-bottom: 5px; }
        select { width:100%; background:#333; color:#fff; border:1px solid #555; padding:5px; border-radius: 3px; }
        
        button.btn-primary { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        button.btn-primary:hover { background: #0062a3; }
        button.btn-primary:disabled { background: #444; cursor: not-allowed; opacity: 0.5; }

        /* MULTI-VIEW MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; width: 98vw; height: 95vh; display: flex; flex-direction: column; border: 1px solid #444; }
        .modal-header { padding: 10px 20px; background: #2d2d30; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; }
        
        .modal-grid-body { 
            flex: 1; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            grid-auto-rows: 1fr;
            gap: 1px; 
            background: #444; 
            overflow: hidden;
            position: relative;
        }

        .view-pane { 
            position: relative; 
            overflow: hidden; 
            background-color: #1e1e1e; 
            cursor: grab; 
            display: flex; 
            justify-content: center; 
            align-items: center;
        }
        .view-pane:active { cursor: grabbing; }
        .pane-label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 12px; z-index: 10; pointer-events: none; border: 1px solid #555; }
        
        .image-content { 
            position: absolute; 
            top: 0; left: 0;
            image-rendering: pixelated; 
            transform-origin: 0 0; 
            user-select: none; 
            pointer-events: none; 
        }

        .bg-grid { background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAIklEQVQYV2NkYGRkYIAAdiGKQAQjI5QNJ2F0QZg441FCLwAAadQAwVqu1d4AAAAASUVORK5CYII='); }
        .bg-dark { background-color: #111; background-image: none; }
        .bg-light { background-color: #ddd; background-image: none; }

        .modal-footer { padding: 5px 20px; background: #2d2d30; border-top: 1px solid #444; display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="back">‚Üê</a>
        <h1>Multi-Palette Studio v6</h1>
    </header>

    <div class="main-container">
        <!-- 1. Sprites -->
        <div class="column col-left">
            <h2>1. –°–ø—Ä–∞–π—Ç—ã</h2>
            <div class="drop-zone" id="spriteDrop">+ –°–ø—Ä–∞–π—Ç—ã<input type="file" id="spriteInput" multiple accept="image/*" style="display:none"></div>
            <div class="sprite-list" id="sourceList"></div>
            <button onclick="clearSprites()" class="mini-btn" style="margin-top:10px; width:100%; background:#444; color:#aaa; border:none; padding:5px; cursor:pointer;">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <!-- 2. Palettes -->
        <div class="column col-center">
            <h2>2. –ü–∞–ª–∏—Ç—Ä—ã (–ú–∞–∫—Å 6)</h2>
            <div id="paletteList" class="palette-list">
                <div style="font-size:12px; color:#666; text-align:center; padding:10px;">–î–æ–±–∞–≤—å—Ç–µ –ø–∞–ª–∏—Ç—Ä—É</div>
            </div>

            <div class="control-group">
                <label>–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä:</label>
                <select id="presetSelect">
                    <option value="" disabled selected>-- –ü—Ä–µ—Å–µ—Ç—ã --</option>
                    <option value="gameboy">GameBoy</option>
                    <option value="pico8">Pico-8</option>
                    <option value="nes">NES</option>
                    <option value="cga1">CGA</option>
                    <option value="sepia">Sepia</option>
                    <option value="bw1bit">1-Bit</option>
                </select>
            </div>
            
            <div class="drop-zone" id="paletteDrop" style="padding:10px; font-size:12px;">+ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—é (PNG/JPG)<input type="file" id="paletteInput" accept="image/*" style="display:none"></div>
            
            <h2>3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="control-group">
                <label>–ú–µ—Ç–æ–¥: <select id="colorMode" style="width:auto; margin-left:5px;"><option value="lab">LAB (–ö–∞—á–µ—Å—Ç–≤–æ)</option><option value="rgb">RGB (–°–∫–æ—Ä–æ—Å—Ç—å)</option></select></label>
                
                <label style="margin-top:10px;">–Ø—Ä–∫–æ—Å—Ç—å: <span id="lumaVal">50%</span></label>
                <input type="range" id="lumaWeight" min="0" max="2" step="0.1" value="1" oninput="updateLabels()">
                
                <label>–°–∏–ª–∞ Mix: <span id="strengthVal">100%</span></label>
                <input type="range" id="strength" min="0" max="1" step="0.05" value="1" oninput="updateLabels()">
                
                <label style="margin-top:10px;"><input type="checkbox" id="dithering"> –î–∏–∑–µ—Ä–∏–Ω–≥</label>
            </div>

            <button class="btn-primary" id="processBtn" onclick="processAll()" disabled>–û–ë–†–ê–ë–û–¢–ê–¢–¨</button>
            <button onclick="downloadAll()" id="downloadAllBtn" style="width:100%; margin-top:10px; padding:10px; background:#333; border:1px solid #555; color:#ddd; border-radius:4px; cursor:pointer; display:none;">–°–∫–∞—á–∞—Ç—å –í—Å–µ (ZIP)</button>
        </div>

        <!-- 3. Results -->
        <div class="column col-right">
            <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
            <div id="resultContainer" style="padding-bottom:50px;"></div>
        </div>
    </div>

    <!-- MULTI-VIEW MODAL -->
    <div class="modal-overlay" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; font-size:16px" id="modalTitle">–ú—É–ª—å—Ç–∏-–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</h3>
                <div style="display:flex; gap:10px; align-items:center;">
                    <select id="bgSelect" style="padding:2px 5px; font-size:12px;">
                        <option value="bg-grid">–°–µ—Ç–∫–∞</option>
                        <option value="bg-dark">–¢–µ–º–Ω—ã–π</option>
                        <option value="bg-light">–°–≤–µ—Ç–ª—ã–π</option>
                    </select>
                    <select id="gridCols" style="padding:2px 5px; font-size:12px;" onchange="updateGridCols()">
                        <option value="auto">–ê–≤—Ç–æ-—Å–µ—Ç–∫–∞</option>
                        <option value="2">2 –ö–æ–ª–æ–Ω–∫–∏</option>
                        <option value="3">3 –ö–æ–ª–æ–Ω–∫–∏</option>
                        <option value="4">4 –ö–æ–ª–æ–Ω–∫–∏</option>
                    </select>
                    <button onclick="closeModal()" style="font-size:24px; color:#fff; background:none; border:none; cursor:pointer;">√ó</button>
                </div>
            </div>
            
            <div class="modal-grid-body" id="modalGrid"></div>
            
            <div class="modal-footer">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span>–ó—É–º: </span>
                    <input type="range" id="zoomRange" min="0.1" max="20" step="0.1" value="1" style="width:100px">
                    <span id="zoomVal">100%</span>
                    <button onclick="resetView()" style="background:#444; color:#fff; border:none; padding:4px 10px; cursor:pointer;">–°–±—Ä–æ—Å</button>
                </div>
                <div style="color:#666;">–¢—è–Ω–∏—Ç–µ –º—ã—à–∫–æ–π –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è ‚Ä¢ –ö–æ–ª–µ—Å–∏–∫–æ –¥–ª—è –∑—É–º–∞</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // State
        let sourceImages = []; 
        let activePalettes = []; 
        let processedResults = {}; 
        let paletteIdCounter = 0;

        const PRESETS = {
            'gameboy': ['#0f380f', '#306230', '#8bac0f', '#9bbc0f'],
            'pico8': ['#000000', '#1D2B53', '#7E2553', '#008751', '#AB5236', '#5F574F', '#C2C3C7', '#FFF1E8', '#FF004D', '#FFA300', '#FFEC27', '#00E436', '#29ADFF', '#83769C', '#FF77A8', '#FFCCAA'],
            'nes': ['#7C7C7C','#0000FC','#0000BC','#4428BC','#940084','#A80020','#A81000','#881400','#503000','#007800','#006800','#005800','#004058','#000000','#BCBCBC','#0078F8','#0058F8','#6844FC','#D800CC','#E40058','#F83800','#E45C10','#AC7C00','#00B800','#00A800','#00A844','#008888','#3CBCFC','#F8F8F8','#3CBCFC','#6888FC','#9878F8','#F878F8','#F85898','#F87858','#FCA044','#F8B800','#B8F818','#58D854','#58F898','#00E8D8','#787878'],
            'cga1': ['#000000', '#55FFFF', '#FF55FF', '#FFFFFF'],
            'sepia': ['#2e211b', '#3d2e24', '#4d3d30', '#5e4d3d', '#706050', '#827262', '#948676', '#a6998b'],
            'bw1bit': ['#000000', '#FFFFFF']
        };

        // --- PALETTE SYSTEM ---
        function addPalette(name, colorsHexOrRGB) {
            if (activePalettes.length >= 6) { alert("–ú–∞–∫—Å–∏–º—É–º 6 –ø–∞–ª–∏—Ç—Ä!"); return; }
            let colors = (typeof colorsHexOrRGB[0] === 'string') 
                ? colorsHexOrRGB.map(hex => {
                    const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
                    return { r, g, b, lab: rgb2lab(r,g,b) };
                }) 
                : colorsHexOrRGB;
            activePalettes.push({ id: ++paletteIdCounter, name: name, colors: colors });
            renderPaletteList();
            checkReady();
        }

        function removePalette(id) {
            activePalettes = activePalettes.filter(p => p.id !== id);
            renderPaletteList();
            checkReady();
        }

        function renderPaletteList() {
            const el = document.getElementById('paletteList');
            if(!activePalettes.length) return el.innerHTML = '<div style="font-size:12px; color:#666; text-align:center; padding:10px;">–ù–µ—Ç –ø–∞–ª–∏—Ç—Ä</div>';
            el.innerHTML = activePalettes.map(p => `
                <div class="palette-item">
                    <div class="palette-header"><span class="palette-name">${p.name}</span><span class="palette-remove" onclick="removePalette(${p.id})">√ó</span></div>
                    <div class="palette-preview-strip">${p.colors.slice(0,20).map(c=>`<div class="color-slice" style="background:rgb(${c.r},${c.g},${c.b})"></div>`).join('')}</div>
                </div>`).join('');
        }

        // --- INPUTS ---
        document.getElementById('presetSelect').addEventListener('change', e => {
            if (PRESETS[e.target.value]) addPalette(e.target.options[e.target.selectedIndex].text, PRESETS[e.target.value]);
            e.target.value = "";
        });

        const palInput = document.getElementById('paletteInput');
        document.getElementById('paletteDrop').addEventListener('click', () => palInput.click());
        palInput.addEventListener('change', e => {
            if(!e.target.files[0]) return;
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas'); c.width=img.width; c.height=img.height;
                const ctx = c.getContext('2d'); ctx.drawImage(img,0,0);
                const data = ctx.getImageData(0,0,c.width,c.height).data;
                const unique = new Set(), ext = [];
                for(let i=0; i<data.length; i+=4) {
                    if(data[i+3]<10) continue;
                    const k = `${data[i]},${data[i+1]},${data[i+2]}`;
                    if(!unique.has(k)) { unique.add(k); ext.push({ r:data[i], g:data[i+1], b:data[i+2], lab: rgb2lab(data[i],data[i+1],data[i+2]) }); }
                }
                if(ext.length) addPalette("Custom", ext);
            };
            img.src = URL.createObjectURL(e.target.files[0]);
            e.target.value="";
        });

        const sprInput = document.getElementById('spriteInput');
        document.getElementById('spriteDrop').addEventListener('click', () => sprInput.click());
        sprInput.addEventListener('change', e => {
            Array.from(e.target.files).forEach(f => {
                const img = new Image();
                img.onload = () => { sourceImages.push({ img, name: f.name }); renderSpriteList(); checkReady(); };
                img.src = URL.createObjectURL(f);
            });
            e.target.value="";
        });
        function renderSpriteList() { document.getElementById('sourceList').innerHTML = sourceImages.map(s => `<div class="source-item"><span>${s.name}</span><span>${s.img.width}x${s.img.height}</span></div>`).join(''); }
        function clearSprites() { sourceImages=[]; renderSpriteList(); checkReady(); }

        // --- PROCESSING ---
        function processAll() {
            const container = document.getElementById('resultContainer');
            container.innerHTML = '<div style="color:#888; padding:20px;">–û–±—Ä–∞–±–æ—Ç–∫–∞...</div>';
            processedResults = {};
            const sets = {
                strength: parseFloat(document.getElementById('strength').value),
                lumaWeight: parseFloat(document.getElementById('lumaWeight').value),
                useLab: document.getElementById('colorMode').value === 'lab',
                useDither: document.getElementById('dithering').checked
            };

            setTimeout(() => {
                container.innerHTML = '';
                sourceImages.forEach(src => {
                    processedResults[src.name] = { original: src.img.src };
                    
                    const row = document.createElement('div'); row.className = 'result-row';
                    const header = document.createElement('div'); header.className = 'row-header';
                    header.innerText = src.name;
                    row.appendChild(header);

                    const scroller = document.createElement('div'); scroller.className = 'row-scroller';
                    
                    // 1. ORIGINAL CARD (Clickable)
                    scroller.innerHTML += `
                    <div class="result-card" onclick="openComparison('${src.name}')" title="–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è">
                        <div class="card-header" style="color:#fff; font-weight:bold;">–û–†–ò–ì–ò–ù–ê–õ</div>
                        <div class="card-img-wrap"><img src="${src.img.src}"></div>
                    </div>`;

                    // 2. PALETTE CARDS (Clickable)
                    activePalettes.forEach(pal => {
                        const blob = processSingle(src.img, pal.colors, sets);
                        const url = URL.createObjectURL(blob);
                        processedResults[src.name][pal.name] = url;

                        scroller.innerHTML += `<div class="result-card" onclick="openComparison('${src.name}')" title="–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è">
                            <div class="card-header">${pal.name}</div>
                            <div class="card-img-wrap"><img src="${url}"></div>
                        </div>`;
                    });
                    row.appendChild(scroller);
                    container.appendChild(row);
                });
                document.getElementById('downloadAllBtn').style.display = 'block';
            }, 50);
        }

        function processSingle(img, palette, s) {
            const c = document.createElement('canvas'); c.width=img.width; c.height=img.height;
            const ctx = c.getContext('2d'); ctx.drawImage(img,0,0);
            const data = ctx.getImageData(0,0,c.width,c.height).data;
            for(let i=0; i<data.length; i+=4) {
                if(data[i+3]<10) continue;
                const r=data[i], g=data[i+1], b=data[i+2];
                let curLab = s.useLab ? rgb2lab(r,g,b) : null;
                let best=palette[0], minDist=Infinity;
                for(const p of palette) {
                    let dist=0;
                    if(s.useLab) {
                        const dL=(curLab.l-p.lab.l)*s.lumaWeight, da=(curLab.a-p.lab.a), db=(curLab.b-p.lab.b);
                        dist=dL*dL+da*da+db*db;
                    } else dist=(r-p.r)**2+(g-p.g)**2+(b-p.b)**2;
                    if(dist<minDist) { minDist=dist; best=p; }
                }
                data[i]=r*(1-s.strength)+best.r*s.strength;
                data[i+1]=g*(1-s.strength)+best.g*s.strength;
                data[i+2]=b*(1-s.strength)+best.b*s.strength;
                
                if(s.useDither && s.strength>0.8) {
                    const er=(r-best.r)*s.strength, eg=(g-best.g)*s.strength, eb=(b-best.b)*s.strength;
                    if(i+4<data.length) { data[i+4]+=er*0.5; data[i+5]+=eg*0.5; data[i+6]+=eb*0.5; }
                }
            }
            ctx.putImageData(new ImageData(data,c.width,c.height),0,0);
            const bin=atob(c.toDataURL('image/png').split(',')[1]);
            const arr=new Uint8Array(bin.length);
            for(let k=0;k<bin.length;k++) arr[k]=bin.charCodeAt(k);
            return new Blob([arr],{type:'image/png'});
        }

        function rgb2lab(r,g,b){
            let r_=r/255,g_=g/255,b_=b/255;
            r_=r_>0.04045?Math.pow((r_+0.055)/1.055,2.4):r_/12.92;
            g_=g_>0.04045?Math.pow((g_+0.055)/1.055,2.4):g_/12.92;
            b_=b_>0.04045?Math.pow((b_+0.055)/1.055,2.4):b_/12.92;
            let x=(r_*0.4124+g_*0.3576+b_*0.1805)/0.95047, y=(r_*0.2126+g_*0.7152+b_*0.0722), z=(r_*0.0193+g_*0.1192+b_*0.9505)/1.08883;
            x=x>0.008856?Math.pow(x,1/3):(7.787*x)+16/116; y=y>0.008856?Math.pow(y,1/3):(7.787*y)+16/116; z=z>0.008856?Math.pow(z,1/3):(7.787*z)+16/116;
            return {l:(116*y)-16, a:500*(x-y), b:200*(y-z)};
        }

        // --- MULTI-PANE LOGIC ---
        const modal = document.getElementById('previewModal');
        const grid = document.getElementById('modalGrid');
        let state = { x:0, y:0, scale:1, dragging:false, sx:0, sy:0 };
        
        function openComparison(name) {
            const data = processedResults[name];
            grid.innerHTML = '';
            document.getElementById('modalTitle').innerText = "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ: " + name;

            // 1. Add Original
            addPane('–û—Ä–∏–≥–∏–Ω–∞–ª', data.original, true);

            // 2. Add Variants
            for(const [key, url] of Object.entries(data)) {
                if(key !== 'original') addPane(key, url, false);
            }
            
            resetView();
            modal.style.display = 'flex';
        }

        function addPane(title, src, isFirst) {
            const pane = document.createElement('div');
            pane.className = 'view-pane bg-grid';
            pane.innerHTML = `<div class="pane-label">${title}</div><img src="${src}" class="image-content">`;
            
            pane.addEventListener('mousedown', startDrag);
            pane.addEventListener('wheel', handleWheel);
            grid.appendChild(pane);
        }

        function closeModal() { modal.style.display='none'; }
        
        function updateTransform() {
            const t = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
            document.querySelectorAll('.image-content').forEach(img => img.style.transform = t);
            document.getElementById('zoomVal').innerText = Math.round(state.scale*100) + '%';
            document.getElementById('zoomRange').value = state.scale;
        }

        function startDrag(e) {
            e.preventDefault();
            state.dragging = true;
            state.sx = e.clientX - state.x;
            state.sy = e.clientY - state.y;
            document.querySelectorAll('.view-pane').forEach(p => p.style.cursor='grabbing');
        }

        window.addEventListener('mousemove', e => {
            if(!state.dragging) return;
            e.preventDefault();
            state.x = e.clientX - state.sx;
            state.y = e.clientY - state.sy;
            updateTransform();
        });

        window.addEventListener('mouseup', () => {
            state.dragging = false;
            document.querySelectorAll('.view-pane').forEach(p => p.style.cursor='grab');
        });

        function handleWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            const newScale = Math.min(Math.max(0.1, state.scale * delta), 20);
            state.scale = newScale;
            updateTransform();
        }

        function resetView() { state.x=0; state.y=0; state.scale=1; updateTransform(); }
        document.getElementById('zoomRange').addEventListener('input', e => { state.scale = parseFloat(e.target.value); updateTransform(); });
        document.getElementById('bgSelect').addEventListener('change', e => document.querySelectorAll('.view-pane').forEach(p => p.className = `view-pane ${e.target.value}`));
        
        function updateGridCols() {
            const cols = document.getElementById('gridCols').value;
            grid.style.gridTemplateColumns = cols === 'auto' ? 'repeat(auto-fit, minmax(300px, 1fr))' : `repeat(${cols}, 1fr)`;
        }

        function checkReady() { document.getElementById('processBtn').disabled = !(sourceImages.length && activePalettes.length); }
        function updateLabels() { document.getElementById('lumaVal').innerText = document.getElementById('lumaWeight').value; document.getElementById('strengthVal').innerText = Math.round(document.getElementById('strength').value * 100) + '%'; }
        
        function downloadAll() {
            const zip = new JSZip();
            Object.keys(processedResults).forEach(name => {
                const f = zip.folder(name);
                Object.entries(processedResults[name]).forEach(([pal, url]) => {
                    if(pal!=='original') f.file(`${pal}.png`, fetch(url).then(r=>r.blob()));
                });
            });
            zip.generateAsync({type:"blob"}).then(c=>{const a=document.createElement('a'); a.href=URL.createObjectURL(c); a.download="pixel_studio.zip"; a.click();});
        }
    </script>
</body>
</html>
