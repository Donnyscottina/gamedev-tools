<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Palette Extractor</title>
    <link rel="icon" type="image/x-icon" href="/gamedev-tools/favicon.ico">
    <link href="style.css" rel="stylesheet">
    <script src="header.js" defer></script>
    <script src="footer.js" defer></script>
    <style>
        /* Tool Specific Styles */
        .drop-area { border: 2px dashed var(--border); padding: 40px; text-align: center; cursor: pointer; border-radius: 8px; margin-bottom: 20px; }
        .drop-area:hover { border-color: var(--accent); background: rgba(0,122,204,0.1); }
        .palette-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 20px; }
        .color-card { background: var(--panel); padding: 5px; border-radius: 4px; text-align: center; cursor: pointer; border: 1px solid var(--border); }
        .color-card:hover { border-color: var(--accent); }
        .color-box { height: 60px; border-radius: 3px; margin-bottom: 5px; border: 1px solid rgba(255,255,255,0.1); }
        .hex-code { font-family: monospace; font-size: 10px; }
        img { max-width: 100%; max-height: 300px; display: block; margin: 0 auto; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Palette Extractor</h2>
        
        <input type="file" id="fileInput" accept="image/*" style="display:none">
        <div class="drop-area" id="dropArea" onclick="document.getElementById('fileInput').click()">
            Нажми или перетащи сюда картинку (Референс/Спрайт)
        </div>

        <div id="previewArea" style="display:none; text-align: center;">
            <img id="sourceImage">
            <div style="margin: 15px 0; color: #888;">Найдено цветов: <span id="colorCount">0</span></div>
            <div class="palette-grid" id="paletteResult"></div>
        </div>
    </div>

    <script src="global.js"></script>

    <script>
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            dropArea.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
        });
        
        dropArea.addEventListener('drop', e => handleFile(e.dataTransfer.files[0]));
        fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

        function handleFile(file) {
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => extractColors(img);
                img.src = e.target.result;
                document.getElementById('sourceImage').src = e.target.result;
                document.getElementById('previewArea').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function extractColors(img) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            const colors = new Set();

            // Проходим по пикселям. Шаг +=4 (R,G,B,A). 
            // Оптимизация: берем каждый 10-й пиксель для скорости, если картинка большая
            const step = (canvas.width * canvas.height > 50000) ? 4 * 10 : 4; 

            for (let i = 0; i < imageData.length; i += step) {
                const r = imageData[i], g = imageData[i+1], b = imageData[i+2], a = imageData[i+3];
                if (a < 128) continue; // Пропускаем прозрачные
                const hex = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
                colors.add(hex);
            }

            // Сортировка по яркости
            const sortedColors = Array.from(colors).sort((a, b) => {
                const getLum = (hex) => {
                    const c = parseInt(hex.substring(1), 16);
                    return 0.2126 * ((c >> 16) & 255) + 0.7152 * ((c >> 8) & 255) + 0.0722 * (c & 255);
                }
                return getLum(b) - getLum(a);
            });

            renderPalette(sortedColors);
        }

        function renderPalette(colors) {
            const grid = document.getElementById('paletteResult');
            document.getElementById('colorCount').innerText = colors.length;
            grid.innerHTML = colors.map(c => `
                <div class="color-card" onclick="navigator.clipboard.writeText('${c}')">
                    <div class="color-box" style="background:${c}"></div>
                    <div class="hex-code">${c}</div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>