<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoundMaker Pro</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root { --knob-size: 40px; --seq-step-size: 32px; }
    body { overflow-y: auto; background-color: #111; }

    .app-grid {
      display: grid;
      grid-template-columns: 280px 1fr 280px;
      gap: 12px;
      padding: 12px;
      max-width: 1400px;
      margin: 0 auto;
      height: calc(100vh - 70px);
    }
    @media (max-width: 1100px) { .app-grid { grid-template-columns: 1fr; height: auto; } }

    .panel {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .panel-head {
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
      padding-bottom: 6px;
    }

    .knob-row { display: flex; flex-wrap: wrap; gap: 12px; justify-content: space-around; }
    .knob-group { display: flex; flex-direction: column; align-items: center; gap: 4px; width: 45px; }
    .knob-group label { font-size: 9px; color: #888; text-transform: uppercase; }

    input[type=range].v-fader {
      -webkit-appearance: slider-vertical;
      width: 24px;
      height: 100px;
      accent-color: var(--accent);
    }

    input[type=range] {
      width: 100%;
      height: 4px;
      background: #333;
      border-radius: 2px;
      -webkit-appearance: none;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      margin-top: -4px;
    }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #444; }

    .btn {
      background: #222;
      border: 1px solid #444;
      color: #ddd;
      padding: 6px 12px;
      font-size: 11px;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      text-transform: uppercase;
      transition: all 0.1s;
    }
    .btn:hover { background: #333; border-color: #666; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: rgba(156,255,138,0.1); color: var(--accent); border-color: var(--accent); }
    .btn.rec { color: #ff5555; border-color: #ff5555; }
    .btn.rec.recording { background: #ff5555; color: #fff; animation: pulse 1s infinite; }
    @keyframes pulse { 0%{opacity:1} 50%{opacity:0.7} 100%{opacity:1} }

    canvas.scope {
      width: 100%;
      height: 120px;
      background: #111;
      border: 1px solid #333;
      border-radius: 4px;
    }

    .seq-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; }

    .step-col {
      display: flex;
      flex-direction: column;
      gap: 2px;
      background: #222;
      padding: 4px;
      border-radius: 4px;
      border: 1px solid transparent;
      user-select: none;
    }
    .step-col.active { border-color: #555; background: #2a2a2a; }

    .step-btn {
      height: 24px;
      border: 1px solid #333;
      background: #151515;
      cursor: pointer;
      border-radius: 2px;
    }
    .step-btn.on { background: var(--accent); box-shadow: 0 0 5px var(--accent); border-color: transparent; }

    .step-param { height: 4px; background: #333; margin-top: 2px; position: relative; }
    .step-param-val { height: 100%; background: #666; width: 50%; }

    select {
      background: #222;
      color: #fff;
      border: 1px solid #444;
      padding: 4px;
      font-size: 11px;
      border-radius: 4px;
      width: 100%;
    }

    .key {
      position: relative;
      display: inline-block;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 0 0 4px 4px;
      width: 30px;
      height: 140px;
      margin: 0 1px;
      cursor: pointer;
    }
    .key:active, .key.pressed { background: #ccc; background-image: linear-gradient(to bottom, #ccc, #aaa); }

    .key.black {
      background: #222;
      border-color: #000;
      height: 84px;
      width: 20px;
      position: absolute;
      z-index: 2;
      top: 0;
    }
    .key.black:active, .key.black.pressed { background: #444; }

    .preset-list { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 8px; }

    .status-bar {
      font-size: 10px;
      color: #666;
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-container">
      <a href="index.html" class="logo">
        <span class="logo-emoji">üéπ</span>
        <span class="logo-text">SoundMaker Pro</span>
      </a>
      <div class="main-nav">
        <a href="index.html">‚Üê Back to Hub</a>
        <a href="#" id="btnInitAudio" style="color:var(--accent)">üîá CLICK TO START AUDIO</a>
      </div>
    </div>
  </header>

  <div class="app-grid">
    <div class="panel">
      <div class="panel-head">OSCILLATOR</div>
      <div class="knob-row">
        <div class="knob-group" style="width:100%">
          <label>Waveform</label>
          <select id="oscWave">
            <option value="sine">Sine</option>
            <option value="square">Square</option>
            <option value="sawtooth">Saw</option>
            <option value="triangle" selected>Triangle</option>
          </select>
        </div>
      </div>

      <div class="panel-head" style="margin-top:10px">ENVELOPE (ADSR)</div>
      <div class="knob-row">
        <div class="knob-group"><input type="range" class="v-fader" id="envA" min="0.005" max="1" step="0.005" value="0.01"><label>A</label></div>
        <div class="knob-group"><input type="range" class="v-fader" id="envD" min="0.01" max="1" step="0.01" value="0.1"><label>D</label></div>
        <div class="knob-group"><input type="range" class="v-fader" id="envS" min="0" max="1" step="0.01" value="0.5"><label>S</label></div>
        <div class="knob-group"><input type="range" class="v-fader" id="envR" min="0.01" max="2" step="0.01" value="0.3"><label>R</label></div>
      </div>

      <div class="panel-head" style="margin-top:10px">FILTER</div>
      <div class="knob-row">
        <div class="knob-group" style="width:100%; margin-bottom: 6px;">
          <input type="range" id="filterCut" min="100" max="10000" step="10" value="3000">
          <label>Cutoff Hz</label>
        </div>
        <div class="knob-group" style="width:100%">
          <input type="range" id="filterRes" min="0" max="20" step="0.5" value="1">
          <label>Resonance</label>
        </div>
      </div>

      <div class="panel-head" style="margin-top:10px">FX: DELAY</div>
      <div class="knob-row">
        <div class="knob-group"><label>Time</label><input type="range" id="delayTime" min="0" max="0.5" step="0.01" value="0.2"></div>
        <div class="knob-group"><label>Fdbk</label><input type="range" id="delayFb" min="0" max="0.8" step="0.01" value="0.3"></div>
        <div class="knob-group"><label>Mix</label><input type="range" id="delayMix" min="0" max="0.5" step="0.01" value="0.2"></div>
      </div>
    </div>

    <div class="panel" style="justify-content: space-between;">
      <div>
        <div class="panel-head">
          <span>MASTER OUTPUT</span>
          <span id="vuMeter" style="color:var(--accent); font-size:9px">‚ñØ‚ñØ‚ñØ‚ñØ‚ñØ</span>
        </div>
        <canvas id="scope" class="scope" width="600" height="120"></canvas>

        <div style="display:flex; gap:10px; margin-top:12px; align-items:flex-end">
          <div style="flex:1">
            <label style="font-size:10px; color:#888; display:block; margin-bottom:4px">MASTER VOL</label>
            <input type="range" id="masterVol" min="0" max="1" step="0.01" value="0.4">
          </div>
          <button id="btnRec" class="btn rec" style="width:110px">‚óè REC</button>
        </div>
      </div>

      <div id="pianoContainer" style="position:relative; height:140px; margin-top:10px; overflow:hidden;">
        <!-- Piano generated by JS -->
      </div>
    </div>

    <div class="panel">
      <div class="panel-head">PRESETS</div>
      <div class="preset-list">
        <button class="btn" onclick="loadPreset('bass')">Bass</button>
        <button class="btn" onclick="loadPreset('lead')">Lead</button>
        <button class="btn" onclick="loadPreset('pad')">Pad</button>
        <button class="btn" onclick="loadPreset('sfx')">SFX</button>
        <button class="btn" onclick="loadPreset('init')">Init</button>
        <button class="btn" onclick="randomizePatch()">üé≤ Rand</button>
      </div>

      <div class="panel-head" style="margin-top:10px">SEQUENCER</div>
      <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
        <button id="btnPlay" class="btn primary" style="flex:1">‚ñ∂ PLAY</button>
        <button id="btnStop" class="btn" style="width:40px">‚ñ†</button>
        <div style="display:flex; flex-direction:column; width:70px;">
           <label style="font-size:9px;color:#888">BPM</label>
           <input type="number" id="bpmNum" value="120" min="40" max="240" style="background:#222; border:1px solid #444; color:#fff; width:100%">
        </div>
      </div>

      <div id="sequencerGrid" class="seq-grid"></div>

      <div style="margin-top:12px; border-top:1px solid #333; padding-top:8px">
        <label style="font-size:10px; color:#888">Selected step note</label>
        <select id="stepNoteSelect"></select>
        <div style="display:flex; gap:10px; margin-top:8px">
           <div style="flex:1"><label style="font-size:9px;color:#888">VEL</label><input type="range" id="stepVel" min="0.1" max="1" step="0.1"></div>
           <div style="flex:1"><label style="font-size:9px;color:#888">DUR</label><input type="range" id="stepDur" min="0.1" max="1" step="0.1"></div>
        </div>
      </div>

      <div class="status-bar">
        <span>Space: Play/Stop</span>
        <span id="recStatus">Ready</span>
      </div>
    </div>
  </div>

  <script>
    let actx = null;
    let masterGain = null;
    let analyzer = null;
    let dest = null;
    let recorder = null;
    let audioChunks = [];

    let activeVoices = {}; // midi -> {osc, gain}

    let filterNode = null;
    let delayNode = null;
    let delayFb = null;
    let delayDry = null;
    let delayWet = null;

    let params = {
      wave: 'triangle',
      a: 0.01, d: 0.1, s: 0.5, r: 0.3,
      cut: 3000, res: 1,
      dTime: 0.2, dFb: 0.3, dMix: 0.2,
      vol: 0.4
    };

    let isPlaying = false;
    let currentStep = 0;
    let nextStepTime = 0;
    let seqTimerID = null;
    let bpm = 120;
    let steps = Array(16).fill().map((_, i) => ({
      active: i % 4 === 0,
      note: 60,
      vel: 0.8,
      dur: 0.5
    }));
    let selectedStepIndex = 0;

    const $ = (id) => document.getElementById(id);

    async function initAudio() {
      if (actx) return;
      actx = new (window.AudioContext || window.webkitAudioContext)();
      await actx.resume();

      masterGain = actx.createGain();
      masterGain.gain.value = params.vol;

      analyzer = actx.createAnalyser();
      analyzer.fftSize = 2048;

      filterNode = actx.createBiquadFilter();
      filterNode.type = 'lowpass';

      delayNode = actx.createDelay(2.0);
      delayFb = actx.createGain();
      delayDry = actx.createGain();
      delayWet = actx.createGain();

      filterNode.connect(delayDry);
      filterNode.connect(delayNode);

      delayNode.connect(delayFb);
      delayFb.connect(delayNode);
      delayNode.connect(delayWet);

      const efxSum = actx.createGain();
      delayDry.connect(efxSum);
      delayWet.connect(efxSum);

      efxSum.connect(analyzer);
      analyzer.connect(masterGain);
      masterGain.connect(actx.destination);

      dest = actx.createMediaStreamDestination();
      masterGain.connect(dest);

      recorder = new MediaRecorder(dest.stream);
      recorder.ondataavailable = (e) => audioChunks.push(e.data);
      recorder.onstop = saveRecording;

      updateParams();
      startScope();

      $('btnInitAudio').textContent = 'AUDIO ON ‚úÖ';
      $('btnInitAudio').style.color = '#fff';
    }

    function m2f(m) { return 440 * Math.pow(2, (m - 69) / 12); }

    function noteOn(midi, vel = 1, dur = 0) {
      if (!actx) initAudio();
      if (actx.state === 'suspended') actx.resume();

      if (activeVoices[midi]) noteOff(midi, true);

      const t = actx.currentTime;
      const osc = actx.createOscillator();
      const gain = actx.createGain();

      osc.type = params.wave;
      osc.frequency.setValueAtTime(m2f(midi), t);

      gain.gain.setValueAtTime(0.0001, t);
      gain.gain.exponentialRampToValueAtTime(Math.max(0.001, vel), t + params.a);
      gain.gain.exponentialRampToValueAtTime(Math.max(0.001, vel * params.s), t + params.a + params.d);

      osc.connect(gain);
      gain.connect(filterNode);

      osc.start(t);

      activeVoices[midi] = { osc, gain };
      highlightKey(midi, true);

      if (dur > 0) {
        const releaseStart = t + dur;
        gain.gain.setValueAtTime(gain.gain.value, releaseStart);
        gain.gain.exponentialRampToValueAtTime(0.001, releaseStart + params.r);
        osc.stop(releaseStart + params.r + 0.05);

        setTimeout(() => highlightKey(midi, false), dur * 1000);
        setTimeout(() => {
          if (activeVoices[midi] && activeVoices[midi].osc === osc) delete activeVoices[midi];
        }, (dur + params.r + 0.1) * 1000);
      }
    }

    function noteOff(midi, force = false) {
      const v = activeVoices[midi];
      if (!v) return;
      const { osc, gain } = v;
      const t = actx.currentTime;

      gain.gain.cancelScheduledValues(t);
      gain.gain.setValueAtTime(Math.max(0.001, gain.gain.value), t);
      const rel = force ? 0.01 : params.r;
      gain.gain.exponentialRampToValueAtTime(0.001, t + rel);
      osc.stop(t + rel + 0.05);

      delete activeVoices[midi];
      highlightKey(midi, false);
    }

    function updateParams() {
      if (!actx) return;
      params.wave = $('oscWave').value;
      params.a = parseFloat($('envA').value);
      params.d = parseFloat($('envD').value);
      params.s = parseFloat($('envS').value);
      params.r = parseFloat($('envR').value);

      params.cut = parseFloat($('filterCut').value);
      params.res = parseFloat($('filterRes').value);
      filterNode.frequency.setTargetAtTime(params.cut, actx.currentTime, 0.05);
      filterNode.Q.setTargetAtTime(params.res, actx.currentTime, 0.05);

      params.dTime = parseFloat($('delayTime').value);
      params.dFb = parseFloat($('delayFb').value);
      params.dMix = parseFloat($('delayMix').value);
      delayNode.delayTime.setTargetAtTime(params.dTime, actx.currentTime, 0.05);
      delayFb.gain.setTargetAtTime(params.dFb, actx.currentTime, 0.05);
      delayWet.gain.setTargetAtTime(params.dMix, actx.currentTime, 0.05);
      delayDry.gain.setTargetAtTime(1 - params.dMix, actx.currentTime, 0.05);

      params.vol = parseFloat($('masterVol').value);
      masterGain.gain.setTargetAtTime(params.vol, actx.currentTime, 0.05);
    }

    function nextNote() {
      const secondsPerBeat = 60.0 / bpm;
      nextStepTime += 0.25 * secondsPerBeat;
      currentStep = (currentStep + 1) % 16;
    }

    function scheduleNote(stepNumber) {
      requestAnimationFrame(() => {
        document.querySelectorAll('.step-col').forEach((el, i) => el.classList.toggle('active', i === stepNumber));
      });

      const s = steps[stepNumber];
      if (s.active) {
        const secondsPer16th = (60.0 / bpm) / 4;
        const duration = Math.max(0.02, s.dur * secondsPer16th * 2);
        noteOn(s.note, s.vel, duration);
      }
    }

    function scheduler() {
      if (!isPlaying) return;
      const lookahead = 25.0;
      const scheduleAheadTime = 0.1;

      while (nextStepTime < actx.currentTime + scheduleAheadTime) {
        scheduleNote(currentStep);
        nextNote();
      }
      seqTimerID = window.setTimeout(scheduler, lookahead);
    }

    function togglePlay() {
      if (!actx) initAudio();
      isPlaying = !isPlaying;

      if (isPlaying) {
        currentStep = 0;
        nextStepTime = actx.currentTime;
        scheduler();
        $('btnPlay').textContent = '‚è∏ PAUSE';
      } else {
        window.clearTimeout(seqTimerID);
        $('btnPlay').textContent = '‚ñ∂ PLAY';
        Object.keys(activeVoices).forEach(k => noteOff(parseInt(k, 10), true));
      }
    }

    function stopAll() {
      isPlaying = false;
      window.clearTimeout(seqTimerID);
      $('btnPlay').textContent = '‚ñ∂ PLAY';
      Object.keys(activeVoices).forEach(k => noteOff(parseInt(k, 10), true));
    }

    function buildPiano() {
      const container = $('pianoContainer');
      container.innerHTML = '';

      const noteNames = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
      const startMidi = 48; // C3
      const endMidi = 72; // C5

      // Build white keys first in a row
      const whiteRow = document.createElement('div');
      whiteRow.style.position = 'relative';
      whiteRow.style.height = '140px';
      whiteRow.style.whiteSpace = 'nowrap';
      container.appendChild(whiteRow);

      const whitePositions = new Map();
      let whiteIndex = 0;

      for (let m = startMidi; m <= endMidi; m++) {
        const n = noteNames[m % 12];
        const isBlack = n.includes('#');
        if (!isBlack) {
          const k = document.createElement('div');
          k.className = 'key';
          k.dataset.midi = String(m);
          k.style.left = '0px';
          k.onmousedown = (e) => { e.preventDefault(); noteOn(m); };
          k.onmouseup = () => noteOff(m);
          k.onmouseleave = () => noteOff(m);
          whiteRow.appendChild(k);
          whitePositions.set(m, whiteIndex);
          whiteIndex++;
        }
      }

      // Now overlay black keys
      for (let m = startMidi; m <= endMidi; m++) {
        const n = noteNames[m % 12];
        const isBlack = n.includes('#');
        if (isBlack) {
          // Find previous white key
          let prev = m - 1;
          while (prev >= startMidi) {
            const pn = noteNames[prev % 12];
            if (!pn.includes('#')) break;
            prev--;
          }
          if (!whitePositions.has(prev)) continue;

          const pos = whitePositions.get(prev);
          const k = document.createElement('div');
          k.className = 'key black';
          k.dataset.midi = String(m);
          k.style.left = (pos * 32 + 22) + 'px';
          k.onmousedown = (e) => { e.preventDefault(); noteOn(m); };
          k.onmouseup = () => noteOff(m);
          k.onmouseleave = () => noteOff(m);
          whiteRow.appendChild(k);
        }
      }
    }

    function highlightKey(midi, on) {
      const k = document.querySelector(`.key[data-midi="${midi}"]`);
      if (k) k.classList.toggle('pressed', on);
    }

    function buildSequencerGrid() {
      const grid = $('sequencerGrid');
      grid.innerHTML = '';

      steps.forEach((step, idx) => {
        const col = document.createElement('div');
        col.className = 'step-col';
        if (idx === selectedStepIndex) col.style.borderColor = '#9cff8a';

        const btn = document.createElement('button');
        btn.className = 'step-btn' + (step.active ? ' on' : '');
        btn.onclick = (e) => {
          step.active = !step.active;
          btn.className = 'step-btn' + (step.active ? ' on' : '');
          selectStep(idx);
          e.stopPropagation();
        };

        const velBar = document.createElement('div');
        velBar.className = 'step-param';
        const velFill = document.createElement('div');
        velFill.className = 'step-param-val';
        velFill.style.width = (step.vel * 100) + '%';
        velBar.appendChild(velFill);

        col.appendChild(btn);
        col.appendChild(velBar);
        col.onclick = () => selectStep(idx);

        grid.appendChild(col);
      });
    }

    function selectStep(idx) {
      selectedStepIndex = idx;
      Array.from($('sequencerGrid').children).forEach((c, i) => {
        c.style.borderColor = (i === idx) ? '#9cff8a' : 'transparent';
      });

      const s = steps[idx];
      $('stepNoteSelect').value = String(s.note);
      $('stepVel').value = String(s.vel);
      $('stepDur').value = String(s.dur);
    }

    function updateStepData() {
      const s = steps[selectedStepIndex];
      s.note = parseInt($('stepNoteSelect').value, 10);
      s.vel = parseFloat($('stepVel').value);
      s.dur = parseFloat($('stepDur').value);
      buildSequencerGrid();
      saveState();
    }

    function buildNoteSelect() {
      const sel = $('stepNoteSelect');
      const noteNames = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
      sel.innerHTML = '';
      for (let m = 36; m < 84; m++) {
        const oct = Math.floor(m / 12) - 1;
        const n = noteNames[m % 12];
        const opt = document.createElement('option');
        opt.value = String(m);
        opt.textContent = `${n}${oct}`;
        sel.appendChild(opt);
      }
    }

    function saveRecording() {
      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = `soundmaker_${Date.now()}.webm`;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      $('recStatus').textContent = 'Saved';
    }

    function toggleRec() {
      if (!actx) initAudio();
      if (recorder.state === 'inactive') {
        audioChunks = [];
        recorder.start();
        $('btnRec').classList.add('recording');
        $('btnRec').textContent = 'STOP';
        $('recStatus').textContent = 'Recording‚Ä¶';
      } else {
        recorder.stop();
        $('btnRec').classList.remove('recording');
        $('btnRec').textContent = '‚óè REC';
        $('recStatus').textContent = 'Processing‚Ä¶';
      }
    }

    const presets = {
      init: { wave:'triangle', a:0.01, d:0.1, s:0.5, r:0.3, cut:5000, res:1, dTime:0.2, dFb:0, dMix:0 },
      bass: { wave:'sawtooth', a:0.01, d:0.2, s:0.2, r:0.1, cut:800, res:5, dTime:0.1, dFb:0.2, dMix:0.1 },
      lead: { wave:'square', a:0.01, d:0.1, s:0.6, r:0.2, cut:2500, res:3, dTime:0.3, dFb:0.4, dMix:0.3 },
      pad:  { wave:'sine', a:0.8, d:1, s:0.8, r:2.0, cut:1500, res:0, dTime:0.4, dFb:0.6, dMix:0.5 },
      sfx:  { wave:'sawtooth', a:0.01, d:0.1, s:0.1, r:0.1, cut:9000, res:15, dTime:0.05, dFb:0.75, dMix:0.35 }
    };

    function loadPreset(name) {
      const p = presets[name];
      if (!p) return;
      $('oscWave').value = p.wave;
      $('envA').value = String(p.a);
      $('envD').value = String(p.d);
      $('envS').value = String(p.s);
      $('envR').value = String(p.r);
      $('filterCut').value = String(p.cut);
      $('filterRes').value = String(p.res);
      $('delayTime').value = String(p.dTime);
      $('delayFb').value = String(p.dFb);
      $('delayMix').value = String(p.dMix);
      updateParams();
      saveState();
    }

    function randomizePatch() {
      const waves = ['sine','square','sawtooth','triangle'];
      $('oscWave').value = waves[Math.floor(Math.random() * waves.length)];
      $('envA').value = (Math.random() * 0.4 + 0.005).toFixed(3);
      $('envD').value = (Math.random() * 1).toFixed(2);
      $('envS').value = (Math.random()).toFixed(2);
      $('envR').value = (Math.random() * 1.5 + 0.01).toFixed(2);
      $('filterCut').value = String(Math.floor(200 + Math.random() * 9000));
      $('filterRes').value = (Math.random() * 12).toFixed(1);
      $('delayTime').value = (Math.random() * 0.45).toFixed(2);
      $('delayFb').value = (Math.random() * 0.75).toFixed(2);
      $('delayMix').value = (Math.random() * 0.45).toFixed(2);
      updateParams();
      saveState();
    }

    function startScope() {
      const canvas = $('scope');
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const data = new Uint8Array(analyzer.fftSize);

      function draw() {
        requestAnimationFrame(draw);
        analyzer.getByteTimeDomainData(data);

        ctx.fillStyle = '#111';
        ctx.fillRect(0, 0, w, h);

        // waveform
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#9cff8a';
        ctx.beginPath();
        const step = w / (data.length - 1);
        for (let i = 0; i < data.length; i++) {
          const v = data[i] / 255;
          const y = v * h;
          const x = i * step;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();

        // VU: compute peak
        let peak = 0;
        for (let i = 0; i < data.length; i++) peak = Math.max(peak, Math.abs(data[i] - 128) / 128);
        let bars = '‚ñØ‚ñØ‚ñØ‚ñØ‚ñØ';
        if (peak > 0.1) bars = '‚ñÆ‚ñØ‚ñØ‚ñØ‚ñØ';
        if (peak > 0.3) bars = '‚ñÆ‚ñÆ‚ñØ‚ñØ‚ñØ';
        if (peak > 0.5) bars = '‚ñÆ‚ñÆ‚ñÆ‚ñØ‚ñØ';
        if (peak > 0.7) bars = '‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñØ';
        if (peak > 0.9) bars = '‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ';
        $('vuMeter').textContent = bars;
      }
      draw();
    }

    function saveState() {
      try {
        const state = {
          bpm,
          params: {
            wave: $('oscWave').value,
            a: $('envA').value,
            d: $('envD').value,
            s: $('envS').value,
            r: $('envR').value,
            cut: $('filterCut').value,
            res: $('filterRes').value,
            dTime: $('delayTime').value,
            dFb: $('delayFb').value,
            dMix: $('delayMix').value,
            vol: $('masterVol').value
          },
          steps
        };
        localStorage.setItem('soundmaker_state_v1', JSON.stringify(state));
      } catch (_) {}
    }

    function loadState() {
      try {
        const raw = localStorage.getItem('soundmaker_state_v1');
        if (!raw) return;
        const s = JSON.parse(raw);
        if (s?.bpm) { bpm = s.bpm; $('bpmNum').value = String(bpm); }
        if (s?.params) {
          $('oscWave').value = s.params.wave ?? $('oscWave').value;
          $('envA').value = s.params.a ?? $('envA').value;
          $('envD').value = s.params.d ?? $('envD').value;
          $('envS').value = s.params.s ?? $('envS').value;
          $('envR').value = s.params.r ?? $('envR').value;
          $('filterCut').value = s.params.cut ?? $('filterCut').value;
          $('filterRes').value = s.params.res ?? $('filterRes').value;
          $('delayTime').value = s.params.dTime ?? $('delayTime').value;
          $('delayFb').value = s.params.dFb ?? $('delayFb').value;
          $('delayMix').value = s.params.dMix ?? $('delayMix').value;
          $('masterVol').value = s.params.vol ?? $('masterVol').value;
        }
        if (Array.isArray(s?.steps) && s.steps.length === 16) steps = s.steps;
      } catch (_) {}
    }

    window.addEventListener('DOMContentLoaded', () => {
      buildPiano();
      buildNoteSelect();
      loadState();
      buildSequencerGrid();
      selectStep(0);

      $('btnInitAudio').onclick = (e) => { e.preventDefault(); initAudio(); };
      $('btnPlay').onclick = togglePlay;
      $('btnStop').onclick = stopAll;
      $('btnRec').onclick = toggleRec;

      $('bpmNum').addEventListener('input', () => { bpm = parseInt($('bpmNum').value, 10) || 120; saveState(); });

      ['oscWave','envA','envD','envS','envR','filterCut','filterRes','delayTime','delayFb','delayMix','masterVol'].forEach(id => {
        $(id).addEventListener('input', () => { updateParams(); saveState(); });
      });

      ['stepNoteSelect','stepVel','stepDur'].forEach(id => {
        $(id).addEventListener('input', updateStepData);
      });

      window.addEventListener('keydown', (e) => {
        if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
      });
    });
  </script>
</body>
</html>
