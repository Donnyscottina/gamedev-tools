<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoundMaker DAW</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root { --track-h: 60px; --knob-size: 50px; }
    body { background: #0a0a0a; overflow-x: hidden; padding-bottom: 40px; }
    .daw-container { max-width: 1600px; margin: 0 auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }

    .transport {
      background: linear-gradient(135deg, #1a1a1a 0%, #222 100%);
      border: 1px solid #333; border-radius: 8px; padding: 16px 20px;
      display: flex; align-items: center; gap: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .transport-controls { display: flex; gap: 10px; }

    .btn {
      background: #2a2a2a; border: 1px solid #444; color: #ddd;
      padding: 10px 18px; font-size: 12px; border-radius: 6px;
      cursor: pointer; font-family: inherit; text-transform: uppercase;
      font-weight: 600; transition: all 0.15s;
      display: flex; align-items: center; gap: 6px;
    }
    .btn:hover { background: #333; border-color: #666; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn.primary { background: var(--accent); color: #000; border-color: var(--accent); }
    .btn.primary:hover { filter: brightness(1.15); }
    .btn.active { background: #ff5555; color: #fff; animation: pulse 1.2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.75; } }

    .bpm-control {
      display: flex; align-items: center; gap: 8px;
      background: #1a1a1a; padding: 8px 14px; border-radius: 6px; border: 1px solid #333;
    }
    .bpm-control label { font-size: 11px; color: #888; text-transform: uppercase; }
    .bpm-control input {
      width: 60px; background: #000; border: 1px solid #444;
      color: var(--accent); padding: 6px; border-radius: 4px;
      font-size: 14px; font-weight: bold; text-align: center;
    }

    .time-display {
      font-family: 'Courier New', monospace; font-size: 18px;
      color: var(--accent); background: #000; padding: 8px 16px;
      border-radius: 6px; border: 1px solid #333;
      min-width: 100px; text-align: center;
    }

    .tracks-area { display: flex; flex-direction: column; gap: 8px; }
    .track {
      background: linear-gradient(135deg, #1a1a1a 0%, #1e1e1e 100%);
      border: 1px solid #333; border-radius: 8px; overflow: hidden; transition: all 0.2s;
    }
    .track:hover { border-color: #444; box-shadow: 0 2px 8px rgba(0,0,0,0.4); }

    .track-header {
      display: flex; align-items: center; padding: 12px 16px;
      background: #222; border-bottom: 1px solid #333; gap: 12px;
    }

    .track-mute, .track-solo {
      width: 32px; height: 32px; border: 1px solid #444;
      background: #2a2a2a; color: #aaa; border-radius: 4px;
      cursor: pointer; font-size: 10px; font-weight: bold; transition: all 0.15s;
    }
    .track-mute:hover, .track-solo:hover { background: #333; }
    .track-mute.active { background: #ff5555; color: #fff; border-color: #ff5555; }
    .track-solo.active { background: #ffcc00; color: #000; border-color: #ffcc00; }

    .track-name {
      flex: 1; font-size: 14px; font-weight: 600;
      color: var(--accent); text-transform: uppercase; letter-spacing: 0.5px;
    }

    .track-vol { display: flex; align-items: center; gap: 8px; }
    .track-vol label { font-size: 10px; color: #888; }
    .track-vol input[type=range] { width: 100px; accent-color: var(--accent); }
    .track-vol-val { font-size: 11px; color: var(--accent); min-width: 35px; text-align: right; }

    .track-body { display: flex; gap: 16px; padding: 16px; }
    .synth-panel { flex: 0 0 300px; display: flex; flex-direction: column; gap: 12px; }

    .param-group {
      background: #0a0a0a; border: 1px solid #333; border-radius: 6px; padding: 10px;
    }
    .param-group-title {
      font-size: 10px; color: #888; text-transform: uppercase;
      letter-spacing: 1px; margin-bottom: 8px;
      border-bottom: 1px solid #222; padding-bottom: 4px;
    }

    .param-row { display: flex; gap: 12px; flex-wrap: wrap; }
    .param {
      display: flex; flex-direction: column; align-items: center;
      gap: 4px; flex: 1; min-width: 70px;
    }
    .param label { font-size: 9px; color: #888; text-transform: uppercase; }
    .param select, .param input {
      width: 100%; background: #1a1a1a; border: 1px solid #444;
      color: #fff; padding: 6px; border-radius: 4px; font-size: 11px;
    }
    .param input[type=range] { accent-color: var(--accent); }

    .sequencer {
      flex: 1; background: #0a0a0a; border: 1px solid #333;
      border-radius: 6px; padding: 12px; overflow-x: auto;
    }

    .seq-grid { display: grid; grid-template-columns: repeat(32, 28px); gap: 2px; }
    .seq-step {
      width: 28px; height: 40px; background: #1a1a1a;
      border: 1px solid #333; border-radius: 3px;
      cursor: pointer; transition: all 0.1s; position: relative;
    }
    .seq-step:hover { background: #252525; border-color: #555; }
    .seq-step.active { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 8px var(--accent); }
    .seq-step.playing { border: 2px solid #fff; animation: playhead 0.1s; }
    @keyframes playhead { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

    .seq-step-note {
      position: absolute; bottom: 2px; left: 0; right: 0;
      font-size: 7px; color: #666; text-align: center;
    }
    .seq-step.active .seq-step-note { color: #000; font-weight: bold; }

    .master-section {
      background: linear-gradient(135deg, #1a1a1a 0%, #222 100%);
      border: 1px solid #333; border-radius: 8px; padding: 20px;
      display: flex; gap: 20px;
    }

    .master-scope { flex: 1; display: flex; flex-direction: column; gap: 10px; }
    canvas.scope {
      width: 100%; height: 120px; background: #000;
      border: 1px solid #333; border-radius: 6px;
    }

    .master-controls { flex: 0 0 250px; display: flex; flex-direction: column; gap: 12px; }
    .fx-rack { background: #0a0a0a; border: 1px solid #333; border-radius: 6px; padding: 12px; }
    .export-section { display: flex; flex-direction: column; gap: 8px; }

    select, input[type=number] {
      background: #1a1a1a; border: 1px solid #444;
      color: #fff; padding: 8px; border-radius: 4px; font-size: 12px;
    }

    .preset-bar { display: flex; gap: 6px; flex-wrap: wrap; }
    .preset-btn { padding: 6px 12px; font-size: 11px; }

    .init-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9); display: flex;
      align-items: center; justify-content: center;
      z-index: 9999; backdrop-filter: blur(10px);
    }
    .init-overlay.hidden { display: none; }
    .init-box {
      background: linear-gradient(135deg, #1a1a1a 0%, #222 100%);
      border: 2px solid var(--accent); border-radius: 12px;
      padding: 40px 60px; text-align: center;
    }
    .init-box h2 { margin: 0 0 20px 0; color: var(--accent); font-size: 24px; }
    .init-box p { margin: 0 0 30px 0; color: #aaa; font-size: 14px; }
  </style>
</head>
<body>
  <div id="initOverlay" class="init-overlay">
    <div class="init-box">
      <h2>üéπ SoundMaker DAW</h2>
      <p>Click below to initialize audio engine</p>
      <button id="btnInitBig" class="btn primary" style="font-size:16px; padding:16px 32px">üîä START AUDIO</button>
    </div>
  </div>

  <header class="site-header">
    <div class="header-container">
      <a href="index.html" class="logo">
        <span class="logo-emoji">üéπ</span>
        <span class="logo-text">SoundMaker DAW</span>
      </a>
      <div class="main-nav">
        <a href="index.html">‚Üê Back to Hub</a>
        <span style="color:var(--accent)" id="statusText">‚è∏ Ready</span>
      </div>
    </div>
  </header>

  <div class="daw-container">
    <div class="transport">
      <div class="transport-controls">
        <button id="btnPlay" class="btn primary">‚ñ∂ PLAY</button>
        <button id="btnStop" class="btn">‚ñ† STOP</button>
        <button id="btnRec" class="btn">‚óè REC</button>
      </div>
      <div class="bpm-control">
        <label>BPM</label>
        <input type="number" id="bpmInput" value="120" min="40" max="240" />
      </div>
      <div class="time-display" id="timeDisplay">00:00</div>
      <div style="flex:1"></div>
      <div class="preset-bar">
        <button class="btn preset-btn" onclick="loadPreset('bass')">Bass</button>
        <button class="btn preset-btn" onclick="loadPreset('lead')">Lead</button>
        <button class="btn preset-btn" onclick="loadPreset('pad')">Pad</button>
        <button class="btn preset-btn" onclick="loadPreset('pluck')">Pluck</button>
        <button class="btn preset-btn" onclick="randomizeAll()">üé≤ Random</button>
      </div>
    </div>

    <div class="tracks-area" id="tracksArea"></div>

    <div class="master-section">
      <div class="master-scope">
        <h3 style="margin:0; font-size:12px; color:#888; text-transform:uppercase">Master Output</h3>
        <canvas id="scopeCanvas" class="scope" width="800" height="120"></canvas>
        <div style="display:flex; gap:12px; align-items:center">
          <label style="font-size:11px; color:#888">MASTER VOL</label>
          <input type="range" id="masterVol" min="0" max="1" step="0.01" value="0.5" style="flex:1" />
          <span id="masterVolVal" style="font-size:12px; color:var(--accent); min-width:40px">50%</span>
        </div>
      </div>

      <div class="master-controls">
        <div class="fx-rack">
          <div class="param-group-title">Master FX</div>
          <div class="param-row">
            <div class="param">
              <label>Delay</label>
              <input type="range" id="fxDelay" min="0" max="0.5" step="0.01" value="0" />
            </div>
            <div class="param">
              <label>Reverb</label>
              <input type="range" id="fxReverb" min="0" max="1" step="0.01" value="0" />
            </div>
          </div>
        </div>

        <div class="export-section">
          <div class="param-group-title">Export</div>
          <button class="btn" onclick="exportWAV()">üíæ Export WAV</button>
          <button class="btn" onclick="exportJSON()">üìÑ Save Project</button>
          <button class="btn" onclick="document.getElementById('loadProject').click()">üìÇ Load</button>
          <input type="file" id="loadProject" accept=".json" style="display:none" />
        </div>
      </div>
    </div>
  </div>

  <script>
    let actx = null;
    let masterGain, analyzer, compressor;
    let delayNode, delayFb, delayDry, delayWet;
    let reverbNode, reverbDry, reverbWet;
    let tracks = [];
    let isPlaying = false;
    let currentStep = 0;
    let bpm = 120;
    let startTime = 0;
    let recorder, audioChunks = [];

    const $ = id => document.getElementById(id);

    // C minor scale: C D Eb F G Ab Bb
    const SCALE = [0, 2, 3, 5, 7, 8, 10]; // semitones from root

    const TRACK_CONFIGS = [
      { 
        name: 'Bass', 
        color: '#ff5555', 
        defaultNote: 36, // C2
        pattern: [
          // Bass groove: C - - C - Eb - G
          {a:1,n:0,v:0.9}, {a:0,n:0,v:0.7}, {a:0,n:0,v:0.7}, {a:0,n:0,v:0.7},
          {a:1,n:0,v:0.8}, {a:0,n:0,v:0.7}, {a:1,n:2,v:0.7}, {a:0,n:0,v:0.7},
          {a:1,n:4,v:0.8}, {a:0,n:0,v:0.7}, {a:1,n:0,v:0.7}, {a:0,n:0,v:0.7},
          {a:1,n:2,v:0.7}, {a:0,n:0,v:0.7}, {a:1,n:4,v:0.8}, {a:0,n:0,v:0.7},
          {a:1,n:0,v:0.9}, {a:0,n:0,v:0.7}, {a:0,n:0,v:0.7}, {a:0,n:0,v:0.7},
          {a:1,n:0,v:0.8}, {a:0,n:0,v:0.7}, {a:1,n:2,v:0.7}, {a:0,n:0,v:0.7},
          {a:1,n:5,v:0.8}, {a:0,n:0,v:0.7}, {a:1,n:4,v:0.7}, {a:0,n:0,v:0.7},
          {a:1,n:2,v:0.7}, {a:0,n:0,v:0.7}, {a:1,n:0,v:0.8}, {a:0,n:0,v:0.7}
        ]
      },
      { 
        name: 'Lead', 
        color: '#55ff55', 
        defaultNote: 60, // C4
        pattern: [
          // Melody: C - Eb - G - F - / Eb - D - C - - - / repeat
          {a:1,n:0,v:0.8}, {a:0,n:0,v:0.7}, {a:1,n:2,v:0.8}, {a:0,n:0,v:0.7},
          {a:1,n:4,v:0.8}, {a:0,n:0,v:0.7}, {a:1,n:3,v:0.7}, {a:0,n:0,v:0.7},
          {a:1,n:2,v:0.8}, {a:0,n:0,v:0.7}, {a:1,n:1,v:0.7}, {a:0,n:0,v:0.7},
          {a:1,n:0,v:0.9}, {a:0,n:0,v:0.7}, {a:0,n:0,v:0.7}, {a:0,n:0,v:0.7},
          {a:1,n:0,v:0.8}, {a:0,n:0,v:0.7}, {a:1,n:2,v:0.8}, {a:0,n:0,v:0.7},
          {a:1,n:4,v:0.8}, {a:0,n:0,v:0.7}, {a:1,n:3,v:0.7}, {a:0,n:0,v:0.7},
          {a:1,n:2,v:0.8}, {a:0,n:0,v:0.7}, {a:1,n:1,v:0.7}, {a:0,n:0,v:0.7},
          {a:1,n:0,v:0.9}, {a:0,n:0,v:0.7}, {a:0,n:0,v:0.7}, {a:0,n:0,v:0.7}
        ]
      },
      { 
        name: 'Pad', 
        color: '#5555ff', 
        defaultNote: 48, // C3
        pattern: [
          // Chords: Cm (C Eb G) for 8 beats, then Fm (F Ab C) for 8 beats
          {a:1,n:0,v:0.6}, {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5},
          {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5},
          {a:1,n:3,v:0.6}, {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5},
          {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5},
          {a:1,n:0,v:0.6}, {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5},
          {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5},
          {a:1,n:4,v:0.6}, {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5},
          {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5}, {a:0,n:0,v:0.5}
        ]
      },
      { 
        name: 'Drums', 
        color: '#ffcc00', 
        defaultNote: 36,
        pattern: [
          // Simple beat: kick on 1 & 3, snare on 2 & 4, hats on every beat
          {a:1,n:0,v:0.9}, {a:1,n:7,v:0.5}, {a:1,n:5,v:0.8}, {a:1,n:7,v:0.5},
          {a:1,n:0,v:0.9}, {a:1,n:7,v:0.5}, {a:1,n:5,v:0.8}, {a:1,n:7,v:0.6},
          {a:1,n:0,v:0.9}, {a:1,n:7,v:0.5}, {a:1,n:5,v:0.8}, {a:1,n:7,v:0.5},
          {a:1,n:0,v:0.9}, {a:1,n:7,v:0.5}, {a:1,n:5,v:0.8}, {a:1,n:7,v:0.6},
          {a:1,n:0,v:0.9}, {a:1,n:7,v:0.5}, {a:1,n:5,v:0.8}, {a:1,n:7,v:0.5},
          {a:1,n:0,v:0.9}, {a:1,n:7,v:0.5}, {a:1,n:5,v:0.8}, {a:1,n:7,v:0.6},
          {a:1,n:0,v:0.9}, {a:1,n:7,v:0.5}, {a:1,n:5,v:0.8}, {a:1,n:7,v:0.5},
          {a:1,n:0,v:0.9}, {a:1,n:7,v:0.5}, {a:1,n:5,v:0.8}, {a:1,n:7,v:0.6}
        ]
      }
    ];

    const presets = {
      bass: { wave: 'sawtooth', a: 0.01, d: 0.2, s: 0.3, r: 0.15, cut: 600, res: 8 },
      lead: { wave: 'square', a: 0.01, d: 0.1, s: 0.7, r: 0.2, cut: 2500, res: 3 },
      pad: { wave: 'sine', a: 0.5, d: 0.8, s: 0.8, r: 1.5, cut: 1200, res: 0 },
      pluck: { wave: 'triangle', a: 0.001, d: 0.15, s: 0, r: 0.1, cut: 3500, res: 2 }
    };

    async function initAudio() {
      if (actx) return;
      
      actx = new (window.AudioContext || window.webkitAudioContext)();
      await actx.resume();

      masterGain = actx.createGain();
      masterGain.gain.value = 0.5;

      compressor = actx.createDynamicsCompressor();
      compressor.threshold.value = -24;
      compressor.knee.value = 30;
      compressor.ratio.value = 12;

      analyzer = actx.createAnalyser();
      analyzer.fftSize = 2048;

      delayNode = actx.createDelay(1.0);
      delayFb = actx.createGain();
      delayDry = actx.createGain();
      delayWet = actx.createGain();
      delayNode.connect(delayFb);
      delayFb.connect(delayNode);

      reverbNode = actx.createConvolver();
      reverbDry = actx.createGain();
      reverbWet = actx.createGain();
      createReverb();

      masterGain.connect(delayDry);
      masterGain.connect(delayNode);
      delayNode.connect(delayWet);
      delayDry.connect(reverbDry);
      delayWet.connect(reverbDry);
      reverbDry.connect(compressor);
      reverbDry.connect(reverbNode);
      reverbNode.connect(reverbWet);
      reverbWet.connect(compressor);
      compressor.connect(analyzer);
      analyzer.connect(actx.destination);

      delayDry.gain.value = 1;
      delayWet.gain.value = 0;
      delayFb.gain.value = 0;
      reverbDry.gain.value = 1;
      reverbWet.gain.value = 0;

      $('fxDelay').oninput = e => {
        const v = parseFloat(e.target.value);
        delayNode.delayTime.value = v;
        delayFb.gain.value = v > 0 ? 0.4 : 0;
        delayWet.gain.value = v > 0 ? 0.3 : 0;
        delayDry.gain.value = 1 - (v > 0 ? 0.3 : 0);
      };

      $('fxReverb').oninput = e => {
        const v = parseFloat(e.target.value);
        reverbWet.gain.value = v * 0.5;
        reverbDry.gain.value = 1 - v * 0.5;
      };

      const dest = actx.createMediaStreamDestination();
      compressor.connect(dest);
      recorder = new MediaRecorder(dest.stream);
      recorder.ondataavailable = e => audioChunks.push(e.data);
      recorder.onstop = () => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `soundmaker_${Date.now()}.webm`;
        a.click();
        URL.revokeObjectURL(url);
        audioChunks = [];
      };

      for (let i = 0; i < 4; i++) createTrack(i);

      startScope();
      $('initOverlay').classList.add('hidden');
      $('statusText').textContent = '‚úÖ Ready';
    }

    function createReverb() {
      const len = actx.sampleRate * 2;
      const buf = actx.createBuffer(2, len, actx.sampleRate);
      for (let ch = 0; ch < 2; ch++) {
        const data = buf.getChannelData(ch);
        for (let i = 0; i < len; i++) {
          data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (len * 0.3));
        }
      }
      reverbNode.buffer = buf;
    }

    function createTrack(index) {
      const cfg = TRACK_CONFIGS[index];
      const track = {
        id: index,
        name: cfg.name,
        color: cfg.color,
        mute: false,
        solo: false,
        volume: index === 3 ? 0.6 : 0.8, // drums quieter
        gain: actx.createGain(),
        filter: actx.createBiquadFilter(),
        params: { wave: 'triangle', a: 0.01, d: 0.1, s: 0.5, r: 0.3, cut: 2000, res: 1 },
        pattern: cfg.pattern.map(p => ({
          active: p.a === 1,
          note: cfg.defaultNote + SCALE[p.n % SCALE.length] + Math.floor(p.n / SCALE.length) * 12,
          vel: p.v
        }))
      };

      track.gain.gain.value = track.volume;
      track.filter.type = 'lowpass';
      track.filter.frequency.value = track.params.cut;
      track.filter.Q.value = track.params.res;
      track.filter.connect(track.gain);
      track.gain.connect(masterGain);

      tracks.push(track);
      renderTrack(track);
    }

    function renderTrack(track) {
      const el = document.createElement('div');
      el.className = 'track';
      el.innerHTML = `
        <div class="track-header">
          <button class="track-mute" data-track="${track.id}">M</button>
          <button class="track-solo" data-track="${track.id}">S</button>
          <div class="track-name">${track.name}</div>
          <div class="track-vol">
            <label>Vol</label>
            <input type="range" min="0" max="1" step="0.01" value="${track.volume}" data-track="${track.id}" class="track-vol-slider" />
            <span class="track-vol-val">${Math.round(track.volume * 100)}%</span>
          </div>
        </div>
        <div class="track-body">
          <div class="synth-panel">
            <div class="param-group">
              <div class="param-group-title">Oscillator</div>
              <div class="param-row">
                <div class="param">
                  <label>Wave</label>
                  <select class="synth-wave" data-track="${track.id}">
                    <option value="sine">Sine</option>
                    <option value="square">Square</option>
                    <option value="sawtooth">Saw</option>
                    <option value="triangle" selected>Tri</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="param-group">
              <div class="param-group-title">Envelope</div>
              <div class="param-row">
                <div class="param"><label>A</label><input type="range" min="0.001" max="1" step="0.001" value="0.01" class="synth-a" data-track="${track.id}" /></div>
                <div class="param"><label>D</label><input type="range" min="0.01" max="1" step="0.01" value="0.1" class="synth-d" data-track="${track.id}" /></div>
                <div class="param"><label>S</label><input type="range" min="0" max="1" step="0.01" value="0.5" class="synth-s" data-track="${track.id}" /></div>
                <div class="param"><label>R</label><input type="range" min="0.01" max="2" step="0.01" value="0.3" class="synth-r" data-track="${track.id}" /></div>
              </div>
            </div>
            <div class="param-group">
              <div class="param-group-title">Filter</div>
              <div class="param-row">
                <div class="param"><label>Cutoff</label><input type="range" min="100" max="10000" step="10" value="2000" class="synth-cut" data-track="${track.id}" /></div>
                <div class="param"><label>Res</label><input type="range" min="0" max="20" step="0.5" value="1" class="synth-res" data-track="${track.id}" /></div>
              </div>
            </div>
          </div>
          <div class="sequencer">
            <div class="seq-grid" id="seq-${track.id}"></div>
          </div>
        </div>
      `;

      $('tracksArea').appendChild(el);
      renderSequencer(track);
      bindTrackEvents(track, el);
    }

    function renderSequencer(track) {
      const grid = $(`seq-${track.id}`);
      grid.innerHTML = '';
      track.pattern.forEach((step, i) => {
        const btn = document.createElement('div');
        btn.className = 'seq-step' + (step.active ? ' active' : '');
        btn.dataset.track = track.id;
        btn.dataset.step = i;
        btn.onclick = () => toggleStep(track.id, i);
        const note = midiToNote(step.note);
        btn.innerHTML = `<div class="seq-step-note">${note}</div>`;
        grid.appendChild(btn);
      });
    }

    function bindTrackEvents(track, el) {
      el.querySelector('.track-mute').onclick = () => {
        track.mute = !track.mute;
        el.querySelector('.track-mute').classList.toggle('active', track.mute);
        track.gain.gain.value = track.mute ? 0 : track.volume;
      };

      el.querySelector('.track-solo').onclick = () => {
        track.solo = !track.solo;
        el.querySelector('.track-solo').classList.toggle('active', track.solo);
        const anySolo = tracks.some(t => t.solo);
        tracks.forEach(t => {
          t.gain.gain.value = anySolo ? (t.solo ? t.volume : 0) : (t.mute ? 0 : t.volume);
        });
      };

      el.querySelector('.track-vol-slider').oninput = e => {
        track.volume = parseFloat(e.target.value);
        track.gain.gain.value = track.mute ? 0 : track.volume;
        el.querySelector('.track-vol-val').textContent = Math.round(track.volume * 100) + '%';
      };

      ['wave', 'a', 'd', 's', 'r', 'cut', 'res'].forEach(param => {
        const inp = el.querySelector(`.synth-${param}`);
        if (!inp) return;
        inp.oninput = () => {
          track.params[param] = param === 'wave' ? inp.value : parseFloat(inp.value);
          if (param === 'cut') track.filter.frequency.setTargetAtTime(track.params.cut, actx.currentTime, 0.05);
          if (param === 'res') track.filter.Q.setTargetAtTime(track.params.res, actx.currentTime, 0.05);
        };
      });
    }

    function toggleStep(trackId, stepId) {
      const track = tracks[trackId];
      track.pattern[stepId].active = !track.pattern[stepId].active;
      renderSequencer(track);
    }

    function playStep(stepIndex) {
      tracks.forEach(track => {
        const step = track.pattern[stepIndex];
        if (step.active && !track.mute) {
          const dur = (60 / bpm) / 8;
          playNote(track, step.note, step.vel, dur);
        }
        const btn = document.querySelector(`[data-track="${track.id}"][data-step="${stepIndex}"]`);
        if (btn) {
          btn.classList.add('playing');
          setTimeout(() => btn.classList.remove('playing'), 100);
        }
      });
    }

    function playNote(track, midi, vel, dur) {
      if (!actx) return;
      const t = actx.currentTime;
      const osc = actx.createOscillator();
      const gain = actx.createGain();

      osc.type = track.params.wave;
      osc.frequency.value = 440 * Math.pow(2, (midi - 69) / 12);

      const p = track.params;
      gain.gain.setValueAtTime(0.0001, t);
      gain.gain.exponentialRampToValueAtTime(vel, t + p.a);
      gain.gain.exponentialRampToValueAtTime(vel * p.s, t + p.a + p.d);
      gain.gain.setValueAtTime(gain.gain.value, t + dur);
      gain.gain.exponentialRampToValueAtTime(0.0001, t + dur + p.r);

      osc.connect(gain);
      gain.connect(track.filter);
      osc.start(t);
      osc.stop(t + dur + p.r + 0.05);
    }

    function scheduler() {
      if (!isPlaying) return;
      const stepDuration = (60 / bpm) / 8;
      const elapsed = actx.currentTime - startTime;
      const expectedStep = Math.floor(elapsed / stepDuration);

      while (currentStep <= expectedStep) {
        playStep(currentStep % 32);
        currentStep++;
      }

      const time = Math.floor(elapsed);
      const mins = Math.floor(time / 60).toString().padStart(2, '0');
      const secs = (time % 60).toString().padStart(2, '0');
      $('timeDisplay').textContent = `${mins}:${secs}`;

      requestAnimationFrame(scheduler);
    }

    function togglePlay() {
      if (!actx) { alert('Click START AUDIO first!'); return; }
      isPlaying = !isPlaying;
      if (isPlaying) {
        startTime = actx.currentTime;
        currentStep = 0;
        scheduler();
        $('btnPlay').textContent = '‚è∏ PAUSE';
        $('statusText').textContent = '‚ñ∂ Playing';
      } else {
        $('btnPlay').textContent = '‚ñ∂ PLAY';
        $('statusText').textContent = '‚è∏ Paused';
      }
    }

    function stopAll() {
      isPlaying = false;
      currentStep = 0;
      $('btnPlay').textContent = '‚ñ∂ PLAY';
      $('timeDisplay').textContent = '00:00';
      $('statusText').textContent = '‚ñ† Stopped';
    }

    function toggleRec() {
      if (!actx) { alert('Init audio first!'); return; }
      if (recorder.state === 'inactive') {
        audioChunks = [];
        recorder.start();
        $('btnRec').classList.add('active');
        $('btnRec').textContent = '‚èπ STOP';
      } else {
        recorder.stop();
        $('btnRec').classList.remove('active');
        $('btnRec').textContent = '‚óè REC';
      }
    }

    function loadPreset(name) {
      const p = presets[name];
      if (!p || !tracks[0]) return;
      const track = tracks[0];
      const els = document.querySelectorAll('[data-track="0"]');
      els.forEach(el => {
        if (el.classList.contains('synth-wave')) el.value = p.wave;
        if (el.classList.contains('synth-a')) el.value = p.a;
        if (el.classList.contains('synth-d')) el.value = p.d;
        if (el.classList.contains('synth-s')) el.value = p.s;
        if (el.classList.contains('synth-r')) el.value = p.r;
        if (el.classList.contains('synth-cut')) el.value = p.cut;
        if (el.classList.contains('synth-res')) el.value = p.res;
      });
      track.params = { ...p };
      if (actx) {
        track.filter.frequency.value = p.cut;
        track.filter.Q.value = p.res;
      }
    }

    function randomizeAll() {
      tracks.forEach(track => {
        track.pattern.forEach((step, i) => {
          step.active = Math.random() > 0.7;
          step.note = 36 + Math.floor(Math.random() * 36);
          step.vel = 0.5 + Math.random() * 0.5;
        });
        renderSequencer(track);
      });
    }

    function exportWAV() {
      alert('Use REC button to record as WebM. For WAV, use external tools or browser extensions.');
    }

    function exportJSON() {
      const data = { bpm, tracks: tracks.map(t => ({ name: t.name, volume: t.volume, params: t.params, pattern: t.pattern })) };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `project_${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function midiToNote(midi) {
      const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
      return notes[midi % 12] + Math.floor(midi / 12 - 1);
    }

    function startScope() {
      const canvas = $('scopeCanvas');
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      const data = new Uint8Array(analyzer.fftSize);

      function draw() {
        requestAnimationFrame(draw);
        analyzer.getByteTimeDomainData(data);

        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, w, h);

        ctx.lineWidth = 2;
        ctx.strokeStyle = '#9cff8a';
        ctx.beginPath();
        const step = w / data.length;
        for (let i = 0; i < data.length; i++) {
          const y = (data[i] / 255) * h;
          const x = i * step;
          i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        }
        ctx.stroke();
      }
      draw();
    }

    $('btnInitBig').onclick = () => initAudio();
    $('btnPlay').onclick = togglePlay;
    $('btnStop').onclick = stopAll;
    $('btnRec').onclick = toggleRec;
    $('bpmInput').oninput = e => bpm = parseInt(e.target.value) || 120;
    $('masterVol').oninput = e => {
      const v = parseFloat(e.target.value);
      if (masterGain) masterGain.gain.value = v;
      $('masterVolVal').textContent = Math.round(v * 100) + '%';
    };

    window.addEventListener('keydown', e => {
      if (e.code === 'Space' && actx) { e.preventDefault(); togglePlay(); }
    });
  </script>
</body>
</html>
