<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Color Reducer</title>
    <style>
        :root { --bg: #1e1e1e; --panel: #252526; --border: #3e3e42; --accent: #007acc; --text: #d4d4d4; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; height: 100vh; margin: 0; display: flex; flex-direction: column; overflow: hidden; }
        
        header { background: var(--panel); padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 20px; flex-shrink: 0; }
        h1 { margin: 0; font-size: 18px; color: #fff; }
        a.back { color: #888; text-decoration: none; font-size: 20px; margin-right: 10px; }

        .main-container { display: flex; flex-grow: 1; overflow: hidden; }
        .col-left { width: 300px; background: var(--panel); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .col-right { flex-grow: 1; background: #151515; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        h2 { font-size: 12px; text-transform: uppercase; color: #888; margin-top: 0; margin-bottom: 10px; }
        
        .drop-zone { border: 2px dashed var(--border); border-radius: 6px; padding: 30px; text-align: center; cursor: pointer; transition: 0.2s; background: rgba(0,0,0,0.2); margin-bottom: 20px; color: #aaa; font-size: 13px; }
        .drop-zone:hover { border-color: var(--accent); background: rgba(0,122,204,0.1); }
        
        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; margin-bottom: 5px; font-size: 13px; }
        input[type="number"], select { width: 100%; background: #333; color: white; border: 1px solid #555; padding: 8px; border-radius: 4px; box-sizing: border-box; }
        
        button.btn-primary { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 10px; }
        button.btn-primary:hover { background: #0062a3; }
        button.btn-sec { background: #333; color: #ddd; border: 1px solid #555; padding: 8px; border-radius: 4px; cursor: pointer; width: 100%; margin-bottom: 5px; }
        button.btn-sec:hover { background: #444; }

        /* Preview Area */
        .preview-area { flex: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; padding: 20px; }
        .canvas-wrap { box-shadow: 0 10px 30px rgba(0,0,0,0.5); background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAIklEQVQYV2NkYGRkYIAAdiGKQAQjI5QNJ2F0QZg441FCLwAAadQAwVqu1d4AAAAASUVORK5CYII='); display: flex; }
        canvas { image-rendering: pixelated; max-width: 100%; max-height: 100%; }

        /* Palette Strip */
        .palette-strip { background: #111; padding: 10px; height: 80px; display: flex; align-items: center; overflow-x: auto; gap: 2px; border-top: 1px solid var(--border); }
        .color-box { min-width: 24px; height: 40px; border: 1px solid rgba(255,255,255,0.1); position: relative; cursor: pointer; }
        .color-box:hover::after { content: attr(title); position: absolute; bottom: 100%; left: 0; background: #000; color: #fff; padding: 2px 5px; font-size: 10px; z-index: 10; white-space: nowrap; }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="back">←</a>
        <h1>Color Reducer</h1>
    </header>

    <div class="main-container">
        <div class="col-left">
            <div class="drop-zone" id="dropZone">
                Перетащи картинку сюда
                <input type="file" id="fileInput" accept="image/*" style="display:none">
            </div>

            <div class="control-group">
                <label>Количество цветов:</label>
                <input type="number" id="colorCount" value="16" min="2" max="256">
            </div>
            
            <div class="control-group">
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="dither" style="margin-right:8px;"> Дизеринг (Floyd-Steinberg)
                </label>
            </div>

            <button class="btn-primary" onclick="processImage()" id="procBtn" disabled>УМЕНЬШИТЬ ЦВЕТА</button>
            
            <div style="border-top:1px solid #333; margin: 10px 0; padding-top:10px;">
                <h2>Экспорт</h2>
                <button class="btn-sec" onclick="downloadImage()">Скачать Картинку</button>
                <button class="btn-sec" onclick="downloadPalette()">Скачать Палитру (PNG)</button>
            </div>
        </div>

        <div class="col-right">
            <div class="preview-area">
                <div class="canvas-wrap">
                    <canvas id="canvas"></canvas>
                </div>
            </div>
            <div class="palette-strip" id="paletteStrip">
                <span style="color:#555; font-size:12px; margin-left:10px;">Палитра появится здесь...</span>
            </div>
        </div>
    </div>

    <script>
        let originalImg = null;
        let palette = []; // [{r,g,b}, ...]

        // Setup Drag & Drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', e => handleFile(e.target.files[0]));
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            dropZone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
        });
        dropZone.addEventListener('drop', e => handleFile(e.dataTransfer.files[0]));

        function handleFile(file) {
            if(!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    originalImg = img;
                    drawImage(img);
                    document.getElementById('procBtn').disabled = false;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function drawImage(img) {
            // Ограничиваем размер для превью, чтобы не вис браузер на 4K
            let w = img.width, h = img.height;
            if(w > 800) { h = Math.round(h * (800/w)); w = 800; }
            canvas.width = w; canvas.height = h;
            ctx.drawImage(img, 0, 0, w, h);
        }

        // --- Median Cut Algorithm Implementation ---
        function processImage() {
            if(!originalImg) return;
            const count = parseInt(document.getElementById('colorCount').value) || 16;
            const useDither = document.getElementById('dither').checked;

            // 1. Get Pixels
            const w = canvas.width, h = canvas.height;
            ctx.drawImage(originalImg, 0, 0, w, h); // Reset
            const imgData = ctx.getImageData(0, 0, w, h);
            const data = imgData.data;
            
            const pixels = [];
            for(let i=0; i<data.length; i+=4) {
                if(data[i+3] < 128) continue; // Ignore transparent
                pixels.push({r: data[i], g: data[i+1], b: data[i+2]});
            }

            if(pixels.length === 0) return;

            // 2. Build Palette using Median Cut
            palette = medianCut(pixels, count);
            renderPaletteStrip();

            // 3. Remap Image
            for(let i=0; i<data.length; i+=4) {
                if(data[i+3] < 10) continue;
                
                const cur = {r: data[i], g: data[i+1], b: data[i+2]};
                const best = findNearest(cur, palette);
                
                data[i] = best.r;
                data[i+1] = best.g;
                data[i+2] = best.b;
                // alpha stays same

                if(useDither) {
                    const er = cur.r - best.r;
                    const eg = cur.g - best.g;
                    const eb = cur.b - best.b;
                    distributeError(data, i, er, eg, eb, w);
                }
            }
            ctx.putImageData(imgData, 0, 0);
        }

        function medianCut(pixels, count) {
            let buckets = [pixels];
            
            while(buckets.length < count) {
                let newBuckets = [];
                let splittable = false;

                for(let i=0; i<buckets.length; i++) {
                    const bucket = buckets[i];
                    if(bucket.length > 1 && newBuckets.length + (buckets.length - i) < count + 5) { // Optimization
                        // Find range
                        let rMin=255, rMax=0, gMin=255, gMax=0, bMin=255, bMax=0;
                        for(let p of bucket) {
                            rMin = Math.min(rMin, p.r); rMax = Math.max(rMax, p.r);
                            gMin = Math.min(gMin, p.g); gMax = Math.max(gMax, p.g);
                            bMin = Math.min(bMin, p.b); bMax = Math.max(bMax, p.b);
                        }
                        const rR = rMax-rMin, gR = gMax-gMin, bR = bMax-bMin;
                        const maxRange = Math.max(rR, gR, bR);
                        
                        if(maxRange === 0) {
                            newBuckets.push(bucket);
                            continue;
                        }

                        // Sort by max channel
                        if(rR === maxRange) bucket.sort((a,b) => a.r - b.r);
                        else if(gR === maxRange) bucket.sort((a,b) => a.g - b.g);
                        else bucket.sort((a,b) => a.b - b.b);

                        const mid = Math.floor(bucket.length / 2);
                        newBuckets.push(bucket.slice(0, mid));
                        newBuckets.push(bucket.slice(mid));
                        splittable = true;
                    } else {
                        newBuckets.push(bucket);
                    }
                }
                
                if(!splittable && newBuckets.length === buckets.length) break; // Cannot split anymore
                buckets = newBuckets;
                if(buckets.length >= count) break;
            }

            // Average colors
            return buckets.map(bucket => {
                let r=0, g=0, b=0;
                for(let p of bucket) { r+=p.r; g+=p.g; b+=p.b; }
                return {
                    r: Math.round(r/bucket.length),
                    g: Math.round(g/bucket.length),
                    b: Math.round(b/bucket.length)
                };
            });
        }

        function findNearest(c, pal) {
            let min = Infinity, best = pal[0];
            for(let p of pal) {
                const dist = (c.r-p.r)**2 + (c.g-p.g)**2 + (c.b-p.b)**2;
                if(dist < min) { min = dist; best = p; }
            }
            return best;
        }

        function distributeError(data, i, er, eg, eb, w) {
            // Floyd-Steinberg
            const add = (idx, f) => {
                if(idx < data.length) {
                    data[idx] = Math.max(0, Math.min(255, data[idx] + er*f));
                    data[idx+1] = Math.max(0, Math.min(255, data[idx+1] + eg*f));
                    data[idx+2] = Math.max(0, Math.min(255, data[idx+2] + eb*f));
                }
            }
            add(i+4, 7/16);
            add(i+w*4-4, 3/16);
            add(i+w*4, 5/16);
            add(i+w*4+4, 1/16);
        }

        function renderPaletteStrip() {
            const strip = document.getElementById('paletteStrip');
            strip.innerHTML = palette.map(c => 
                `<div class="color-box" style="background:rgb(${c.r},${c.g},${c.b})" title="rgb(${c.r},${c.g},${c.b})"></div>`
            ).join('');
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'reduced_image.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        function downloadPalette() {
            if(palette.length === 0) return;
            // Create a small canvas for palette
            const pc = document.createElement('canvas');
            pc.width = palette.length; pc.height = 1;
            const pctx = pc.getContext('2d');
            palette.forEach((c, i) => {
                pctx.fillStyle = `rgb(${c.r},${c.g},${c.b})`;
                pctx.fillRect(i, 0, 1, 1);
            });
            const link = document.createElement('a');
            link.download = 'generated_palette.png';
            link.href = pc.toDataURL();
            link.click();
        }
    </script>
</body>
</html>
