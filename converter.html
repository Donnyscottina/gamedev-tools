<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Image Converter</title>
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header will be injected by global.js, but back link inside container is useful too -->
        
        <div class="control-panel" style="margin-top: 20px;">
            <label>1. Выбери формат выхода:
                <select id="format">
                    <option value="image/webp">WebP (Для веба / Игр)</option>
                    <option value="image/jpeg">JPEG (Фото)</option>
                    <option value="image/png">PNG (Спрайты)</option>
                </select>
            </label>
            <label>2. Качество (0.1 - 1.0):
                <input type="range" id="quality" min="0.1" max="1" step="0.1" value="0.9">
            </label>
            <label>3. Загрузи файлы:
                <input type="file" id="files" multiple accept="image/*" style="margin-top:5px;">
            </label>
        </div>

        <div class="list" id="resultList"></div>
    </div>

    <script src="global.js"></script>

    <script>
        document.getElementById('files').addEventListener('change', async (e) => {
            const files = e.target.files;
            const format = document.getElementById('format').value;
            const quality = parseFloat(document.getElementById('quality').value);
            const list = document.getElementById('resultList');
            list.innerHTML = '';

            for (let file of files) {
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `<span>⏳ ${file.name}...</span>`;
                list.appendChild(item);

                try {
                    const blob = await convertImage(file, format, quality);
                    const ext = format.split('/')[1];
                    const newName = file.name.split('.')[0] + '.' + ext;
                    
                    const url = URL.createObjectURL(blob);
                    item.innerHTML = `
                        <span>✅ ${newName}</span>
                        <a href="${url}" download="${newName}" class="download-link">Скачать</a>
                    `;
                } catch (err) {
                    item.innerHTML = `<span style="color:red">Ошибка: ${file.name}</span>`;
                    console.error(err);
                }
            }
        });

        function convertImage(file, format, quality) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    canvas.toBlob(blob => resolve(blob), format, quality);
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }
    </script>
</body>
</html>