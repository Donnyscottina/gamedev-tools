<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Pixel Art Editor Pro</title>
    <style>
        :root {
            --bg: #1e1e1e;
            --panel: #252526;
            --border: #3e3e42;
            --accent: #007acc;
            --text: #d4d4d4;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; margin: 0; overflow: hidden; user-select: none; }
        
        /* –¢—É–ª–±–∞—Ä —Å–ª–µ–≤–∞ */
        .toolbar { width: 50px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 10px 0; gap: 8px; z-index: 10; }
        .tool-btn { width: 36px; height: 36px; border: 1px solid transparent; background: transparent; color: #fff; border-radius: 4px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: 0.1s; position: relative;}
        .tool-btn:hover { background: #3e3e42; }
        .tool-btn.active { background: var(--accent); border-color: #0098ff; }
        .tool-btn .key { position: absolute; bottom: 2px; right: 2px; font-size: 8px; color: rgba(255,255,255,0.7); }

        /* –†–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å */
        .workspace { flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        
        .top-bar { height: 40px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 15px; gap: 20px; font-size: 13px; }
        
        .canvas-viewport { 
            flex-grow: 1; 
            background: #151515; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: auto; 
            position: relative;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ª–æ–µ–≤ */
        .drawing-board {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            /* –®–∞—Ö–º–∞—Ç–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ */
            background-image: 
                linear-gradient(45deg, #333 25%, transparent 25%), 
                linear-gradient(-45deg, #333 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #333 75%), 
                linear-gradient(-45deg, transparent 75%, #333 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #222;
        }

        canvas { 
            position: absolute; 
            top: 0; left: 0; 
            image-rendering: pixelated; 
        }
        
        #artCanvas { z-index: 1; }
        #gridCanvas { z-index: 2; pointer-events: none; opacity: 0.5; }

        /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .panels { width: 260px; background: var(--panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .panel { padding: 15px; border-bottom: 1px solid var(--border); }
        .panel h3 { margin: 0 0 10px 0; font-size: 12px; text-transform: uppercase; color: #888; letter-spacing: 1px; }
        
        .palette { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; }
        .color-swatch { width: 100%; aspect-ratio: 1; border-radius: 2px; cursor: pointer; border: 1px solid #000; box-sizing: border-box;}
        .color-swatch:hover { transform: scale(1.1); z-index: 2; border: 1px solid white; }
        
        input[type="number"], input[type="color"] { background: #3c3c3c; border: 1px solid #555; color: white; padding: 4px; border-radius: 2px; }
        
        button.action { background: var(--accent); color: white; border: none; padding: 10px; width: 100%; border-radius: 4px; cursor: pointer; margin-top: 5px; font-weight: 600; }
        button.action:hover { background: #0062a3; }
        
        .preview-box {
            width: 100%; height: 100px; 
            background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAIklEQVQYV2NkYGRkYIAAdiGKQAQjI5QNJ2F0QZg441FCLwAAadQAwVqu1d4AAAAASUVORK5CYII='); /* –ú–µ–ª–∫–∞—è —à–∞—Ö–º–∞—Ç–∫–∞ */
            display: flex; justify-content: center; align-items: center;
            border: 1px solid var(--border);
            margin-bottom: 10px;
        }
        #previewImg { image-rendering: pixelated; background: transparent; border: 1px solid rgba(255,255,255,0.2); }

        a.back-link { text-decoration: none; color: #888; font-size: 20px; }
    </style>
</head>
<body>
    <div class="toolbar">
        <a href="index.html" class="back-link" title="–ù–∞–∑–∞–¥">üè†</a>
        <div class="tool-btn active" onclick="setTool('pencil')" title="–ö–∞—Ä–∞–Ω–¥–∞—à (B)">‚úèÔ∏è<span class="key">B</span></div>
        <div class="tool-btn" onclick="setTool('eraser')" title="–õ–∞—Å—Ç–∏–∫ (E)">üßº<span class="key">E</span></div>
        <div class="tool-btn" onclick="setTool('fill')" title="–ó–∞–ª–∏–≤–∫–∞ (F)">ü™£<span class="key">F</span></div>
        <div class="tool-btn" onclick="setTool('picker')" title="–ü–∏–ø–µ—Ç–∫–∞ (I)">üíâ<span class="key">I</span></div>
        <div style="flex-grow:1"></div>
        <div class="tool-btn" onclick="clearCanvas()" title="–û—á–∏—Å—Ç–∏—Ç—å (Del)">üóëÔ∏è</div>
    </div>

    <div class="workspace">
        <div class="top-bar">
            <span>–†–∞–∑–º–µ—Ä: <input type="number" id="sizeX" value="32" style="width:50px" min="1" max="128"> x <input type="number" id="sizeY" value="32" style="width:50px" min="1" max="128"></span>
            <button onclick="resizeCanvas()" style="padding: 4px 10px; cursor:pointer;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <div style="width:1px; height:20px; background:#444; margin:0 10px;"></div>
            <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
                <input type="checkbox" id="showGrid" checked onchange="drawGrid()"> 
                –°–µ—Ç–∫–∞
            </label>
        </div>
        
        <div class="canvas-viewport">
            <div class="drawing-board" id="board">
                <canvas id="artCanvas"></canvas>
                <canvas id="gridCanvas"></canvas>
            </div>
        </div>
    </div>

    <div class="panels">
        <div class="panel">
            <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (1x)</h3>
            <div class="preview-box">
                <canvas id="previewCanvas"></canvas>
            </div>
        </div>

        <div class="panel">
            <h3>–ê–∫—Ç–∏–≤–Ω—ã–π —Ü–≤–µ—Ç</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="color" id="colorPicker" value="#000000" style="height: 30px; flex-grow:1; cursor:pointer;">
                <div id="hexValue" style="font-family: monospace; font-size: 12px; color:#888;">#000000</div>
            </div>
        </div>
        
        <div class="panel">
            <h3>–ü–∞–ª–∏—Ç—Ä–∞ (Pico-8)</h3>
            <div class="palette" id="paletteBox"></div>
        </div>
        
        <div class="panel">
            <button class="action" onclick="downloadImage()">üíæ –°–∫–∞—á–∞—Ç—å PNG</button>
        </div>
    </div>

    <script>
        // --- –ö–æ–Ω—Ñ–∏–≥ ---
        const ZOOM = 20; // –í–∏–∑—É–∞–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
        const defaultPalette = [
            '#000000', '#1D2B53', '#7E2553', '#008751', '#AB5236', '#5F574F', '#C2C3C7', '#FFF1E8',
            '#FF004D', '#FFA300', '#FFEC27', '#00E436', '#29ADFF', '#83769C', '#FF77A8', '#FFCCAA'
        ];

        // --- –≠–ª–µ–º–µ–Ω—Ç—ã ---
        const artCanvas = document.getElementById('artCanvas');
        const gridCanvas = document.getElementById('gridCanvas');
        const previewCanvas = document.getElementById('previewCanvas');
        const board = document.getElementById('board');
        const artCtx = artCanvas.getContext('2d');
        const gridCtx = gridCanvas.getContext('2d');
        const prevCtx = previewCanvas.getContext('2d');

        // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ ---
        let width = 32, height = 32;
        let currentTool = 'pencil';
        let currentColor = '#000000';
        let isDrawing = false;
        
        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        function init() {
            // –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ª–∏—Ç—Ä—ã
            const palBox = document.getElementById('paletteBox');
            defaultPalette.forEach(c => {
                const d = document.createElement('div');
                d.className = 'color-swatch';
                d.style.backgroundColor = c;
                d.title = c;
                d.onclick = () => selectColor(c);
                palBox.appendChild(d);
            });
            
            // –•–æ—Ç–∫–µ–∏
            document.addEventListener('keydown', e => {
                if (e.target.tagName === 'INPUT') return;
                switch(e.key.toLowerCase()) {
                    case 'b': setTool('pencil'); break;
                    case 'e': setTool('eraser'); break;
                    case 'f': setTool('fill'); break;
                    case 'i': setTool('picker'); break;
                    case 'delete': clearCanvas(); break;
                }
            });

            resizeCanvas();
        }

        function resizeCanvas() {
            width = parseInt(document.getElementById('sizeX').value);
            height = parseInt(document.getElementById('sizeY').value);
            
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            [artCanvas, gridCanvas].forEach(c => {
                c.width = width;
                c.height = height;
                // –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ CSS –¥–ª—è –∑—É–º–∞
                c.style.width = (width * ZOOM) + 'px';
                c.style.height = (height * ZOOM) + 'px';
            });
            
            board.style.width = (width * ZOOM) + 'px';
            board.style.height = (height * ZOOM) + 'px';

            // –ü—Ä–µ–≤—å—é
            previewCanvas.width = width;
            previewCanvas.height = height;
            // –ü—Ä–µ–≤—å—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Å–æ–≤—Å–µ–º –º–µ–ª–∫–∞—è
            const prevZoom = width < 32 ? 2 : 1;
            previewCanvas.style.width = (width * prevZoom) + 'px';
            previewCanvas.style.height = (height * prevZoom) + 'px';

            drawGrid();
            updatePreview();
        }

        // --- –†–∏—Å–æ–≤–∞–Ω–∏–µ –°–µ—Ç–∫–∏ ---
        function drawGrid() {
            gridCtx.clearRect(0, 0, width, height);
            if (!document.getElementById('showGrid').checked) return;

            gridCtx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            gridCtx.lineWidth = 0.05; // –¢–æ–Ω–∫–∞—è –ª–∏–Ω–∏—è –ø—Ä–∏ –∑—É–º–µ

            gridCtx.beginPath();
            for (let x = 0; x <= width; x++) {
                gridCtx.moveTo(x, 0);
                gridCtx.lineTo(x, height);
            }
            for (let y = 0; y <= height; y++) {
                gridCtx.moveTo(0, y);
                gridCtx.lineTo(width, height); // fix
                gridCtx.moveTo(0, y);
                gridCtx.lineTo(width, y);
            }
            gridCtx.stroke();
        }

        // --- –õ–æ–≥–∏–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ ---
        function selectColor(hex) {
            currentColor = hex;
            document.getElementById('colorPicker').value = hex;
            document.getElementById('hexValue').innerText = hex;
            if (currentTool === 'eraser') setTool('pencil');
        }

        document.getElementById('colorPicker').addEventListener('input', e => selectColor(e.target.value));

        function setTool(t) {
            currentTool = t;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`[onclick="setTool('${t}')"]`);
            if(btn) btn.classList.add('active');
            
            // –ö—É—Ä—Å–æ—Ä
            board.style.cursor = t === 'picker' ? 'alias' : (t === 'fill' ? 'cell' : 'crosshair');
        }

        function getCoords(e) {
            const rect = artCanvas.getBoundingClientRect();
            // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ CSS —Ä–∞–∑–º–µ—Ä–∞, –¥–µ–ª–∏–º –Ω–∞ ZOOM
            const x = Math.floor((e.clientX - rect.left) / ZOOM);
            const y = Math.floor((e.clientY - rect.top) / ZOOM);
            return {x, y};
        }

        function drawPixel(x, y) {
            if (x < 0 || y < 0 || x >= width || y >= height) return;

            if (currentTool === 'pencil') {
                artCtx.fillStyle = currentColor;
                artCtx.fillRect(x, y, 1, 1);
            } else if (currentTool === 'eraser') {
                artCtx.clearRect(x, y, 1, 1);
            }
        }

        function pickColor(x, y) {
            if (x < 0 || x >= width || y < 0 || y >= height) return;
            const p = artCtx.getImageData(x, y, 1, 1).data;
            if (p[3] === 0) return; // –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π
            // RGB to Hex
            const hex = "#" + ((1 << 24) + (p[0] << 16) + (p[1] << 8) + p[2]).toString(16).slice(1);
            selectColor(hex);
            setTool('pencil');
        }

        function floodFill(startX, startY) {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ü–≤–µ—Ç –ø–∏–∫—Å–µ–ª—è
            const startData = artCtx.getImageData(startX, startY, 1, 1).data;
            const startHex = startData[3] === 0 ? null : 
                "#" + ((1 << 24) + (startData[0] << 16) + (startData[1] << 8) + startData[2]).toString(16).slice(1);
            
            // –ï—Å–ª–∏ —Ü–≤–µ—Ç —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–º - –≤—ã—Ö–æ–¥–∏–º
            if (startHex === currentColor && currentTool !== 'eraser') return;
            if (startHex === null && currentTool === 'eraser') return;

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–µ–∫ –¥–ª—è –∑–∞–ª–∏–≤–∫–∏ (–Ω–µ —Ä–µ–∫—É—Ä—Å–∏—é, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–∏—Ç—å —Å—Ç–µ–∫)
            const stack = [[startX, startY]];
            const w = width;
            const h = height;

            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
            const imgData = artCtx.getImageData(0, 0, w, h);
            const data = imgData.data;

            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º currentColor –≤ RGBA
            let r, g, b, a;
            if (currentTool === 'eraser') {
                r=0; g=0; b=0; a=0;
            } else {
                const bigint = parseInt(currentColor.slice(1), 16);
                r = (bigint >> 16) & 255;
                g = (bigint >> 8) & 255;
                b = bigint & 255;
                a = 255;
            }

            const matchStartColor = (pos) => {
                return data[pos] === startData[0] && 
                       data[pos+1] === startData[1] && 
                       data[pos+2] === startData[2] && 
                       data[pos+3] === startData[3];
            };

            const colorPixel = (pos) => {
                data[pos] = r; data[pos+1] = g; data[pos+2] = b; data[pos+3] = a;
            };

            while (stack.length) {
                const [x, y] = stack.pop();
                const pos = (y * w + x) * 4;

                if (matchStartColor(pos)) {
                    colorPixel(pos);
                    if (x > 0) stack.push([x - 1, y]);
                    if (x < w - 1) stack.push([x + 1, y]);
                    if (y > 0) stack.push([x, y - 1]);
                    if (y < h - 1) stack.push([x, y + 1]);
                }
            }
            artCtx.putImageData(imgData, 0, 0);
        }

        function updatePreview() {
            prevCtx.clearRect(0, 0, width, height);
            prevCtx.drawImage(artCanvas, 0, 0);
        }

        function clearCanvas() {
            if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ?')) {
                artCtx.clearRect(0, 0, width, height);
                updatePreview();
            }
        }

        // --- –°–æ–±—ã—Ç–∏—è –º—ã—à–∏ ---
        const getHandler = (e) => {
            const p = getCoords(e);
            
            if (currentTool === 'picker') {
                pickColor(p.x, p.y);
            } else if (currentTool === 'fill') {
                floodFill(p.x, p.y);
                updatePreview();
            } else {
                isDrawing = true;
                drawPixel(p.x, p.y);
                updatePreview();
            }
        };

        gridCanvas.addEventListener('mousedown', e => {
            if(e.button !== 0) return; // –¢–æ–ª—å–∫–æ –ª–µ–≤—ã–π –∫–ª–∏–∫
            getHandler(e);
        });

        window.addEventListener('mouseup', () => isDrawing = false);
        
        gridCanvas.addEventListener('mousemove', e => {
            if (!isDrawing) return;
            const p = getCoords(e);
            drawPixel(p.x, p.y);
            updatePreview(); // –ú–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å, –≤—ã–∑—ã–≤–∞—è —Ä–µ–∂–µ
        });

        function downloadImage() {
            const link = document.createElement('a');
            link.download = `pixelart_${width}x${height}_${Date.now()}.png`;
            link.href = artCanvas.toDataURL('image/png');
            link.click();
        }

        init();
    </script>
</body>
</html>
