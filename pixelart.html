<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Pixel Art Editor Pro (Fixed)</title>
    <style>
        :root {
            --bg: #1e1e1e;
            --panel: #252526;
            --border: #3e3e42;
            --accent: #007acc;
            --text: #d4d4d4;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; margin: 0; overflow: hidden; user-select: none; }
        
        /* –¢—É–ª–±–∞—Ä */
        .toolbar { width: 50px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 10px 0; gap: 8px; z-index: 10; }
        .tool-btn { width: 36px; height: 36px; background: transparent; color: #fff; border: 1px solid transparent; border-radius: 4px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; position: relative;}
        .tool-btn:hover { background: #3e3e42; }
        .tool-btn.active { background: var(--accent); border-color: #0098ff; }
        .tool-btn .key { position: absolute; bottom: 2px; right: 2px; font-size: 8px; color: rgba(255,255,255,0.7); }

        /* –†–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å */
        .workspace { flex-grow: 1; display: flex; flex-direction: column; }
        .top-bar { height: 40px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 15px; gap: 20px; font-size: 13px; }
        
        .canvas-viewport { 
            flex-grow: 1; 
            background: #151515; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: auto; 
        }

        /* –î–æ—Å–∫–∞ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è */
        .drawing-board {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            /* –®–∞—Ö–º–∞—Ç–Ω—ã–π —Ñ–æ–Ω (–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å) */
            background-color: #222;
            background-image: 
                linear-gradient(45deg, #333 25%, transparent 25%), 
                linear-gradient(-45deg, #333 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #333 75%), 
                linear-gradient(-45deg, transparent 75%, #333 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        canvas { 
            position: absolute; 
            top: 0; left: 0; 
            image-rendering: pixelated; 
        }
        
        /* –°–õ–û–ò: Art –≤–Ω–∏–∑—É (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–ª–∏–∫–∏), Grid —Å–≤–µ—Ä—Ö—É (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∫–ª–∏–∫–∏) */
        #artCanvas { z-index: 10; cursor: crosshair; }
        #gridCanvas { z-index: 20; pointer-events: none; opacity: 0.5; }

        /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .panels { width: 260px; background: var(--panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .panel { padding: 15px; border-bottom: 1px solid var(--border); }
        .panel h3 { margin: 0 0 10px 0; font-size: 12px; text-transform: uppercase; color: #888; }
        
        .palette { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; }
        .color-swatch { width: 100%; aspect-ratio: 1; border-radius: 2px; cursor: pointer; border: 1px solid #000; box-sizing: border-box;}
        .color-swatch:hover { transform: scale(1.1); z-index: 50; border: 1px solid white; box-shadow: 0 0 5px black; }
        
        input[type="number"], input[type="color"] { background: #3c3c3c; border: 1px solid #555; color: white; padding: 4px; border-radius: 2px; }
        button.action { background: var(--accent); color: white; border: none; padding: 10px; width: 100%; border-radius: 4px; cursor: pointer; margin-top: 5px; font-weight: 600; }
        button.action:hover { background: #0062a3; }
        
        .preview-box {
            width: 100%; height: 100px; 
            background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAIklEQVQYV2NkYGRkYIAAdiGKQAQjI5QNJ2F0QZg441FCLwAAadQAwVqu1d4AAAAASUVORK5CYII=');
            display: flex; justify-content: center; align-items: center;
            border: 1px solid var(--border);
            margin-bottom: 10px;
        }
        #previewCanvas { image-rendering: pixelated; background: transparent; border: 1px solid rgba(255,255,255,0.2); }
        a.back-link { text-decoration: none; color: #888; font-size: 20px; }
    </style>
</head>
<body>
    <div class="toolbar">
        <a href="index.html" class="back-link" title="–ú–µ–Ω—é">üè†</a>
        <div class="tool-btn active" onclick="setTool('pencil')" title="B">‚úèÔ∏è<span class="key">B</span></div>
        <div class="tool-btn" onclick="setTool('eraser')" title="E">üßº<span class="key">E</span></div>
        <div class="tool-btn" onclick="setTool('fill')" title="F">ü™£<span class="key">F</span></div>
        <div class="tool-btn" onclick="setTool('picker')" title="I">üíâ<span class="key">I</span></div>
        <div style="flex-grow:1"></div>
        <div class="tool-btn" onclick="clearCanvas()" title="Del">üóëÔ∏è</div>
    </div>

    <div class="workspace">
        <div class="top-bar">
            <span>–†–∞–∑–º–µ—Ä: <input type="number" id="sizeX" value="32" style="width:50px" min="1" max="64"> x <input type="number" id="sizeY" value="32" style="width:50px" min="1" max="64"></span>
            <button onclick="resizeCanvas()" style="padding: 4px 10px; cursor:pointer;">OK</button>
            <div style="width:1px; height:20px; background:#444; margin:0 10px;"></div>
            <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
                <input type="checkbox" id="showGrid" checked onchange="drawGrid()"> –°–µ—Ç–∫–∞
            </label>
        </div>
        
        <div class="canvas-viewport">
            <div class="drawing-board" id="board">
                <!-- –í–∞–∂–Ω–æ: artCanvas –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–ª–∏–∫–∏, gridCanvas –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∏—Ö -->
                <canvas id="artCanvas"></canvas>
                <canvas id="gridCanvas"></canvas>
            </div>
        </div>
    </div>

    <div class="panels">
        <div class="panel">
            <h3>–ü—Ä–µ–≤—å—é (1x)</h3>
            <div class="preview-box">
                <canvas id="previewCanvas"></canvas>
            </div>
        </div>

        <div class="panel">
            <h3>–¶–≤–µ—Ç</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="color" id="colorPicker" value="#000000" style="height: 30px; flex-grow:1; cursor:pointer;">
            </div>
        </div>
        
        <div class="panel">
            <h3>–ü–∞–ª–∏—Ç—Ä–∞</h3>
            <div class="palette" id="paletteBox"></div>
        </div>
        
        <div class="panel">
            <button class="action" onclick="downloadImage()">üíæ PNG</button>
        </div>
    </div>

    <script>
        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
        const ZOOM = 20; // 1 –ø–∏–∫—Å–µ–ª—å = 20 —ç–∫—Ä–∞–Ω–Ω—ã—Ö –ø–∏–∫—Å–µ–ª–µ–π
        const defaultPalette = [
            '#000000', '#1D2B53', '#7E2553', '#008751', '#AB5236', '#5F574F', '#C2C3C7', '#FFF1E8',
            '#FF004D', '#FFA300', '#FFEC27', '#00E436', '#29ADFF', '#83769C', '#FF77A8', '#FFCCAA'
        ];

        // --- DOM ---
        const artCanvas = document.getElementById('artCanvas');
        const gridCanvas = document.getElementById('gridCanvas');
        const previewCanvas = document.getElementById('previewCanvas');
        const board = document.getElementById('board');
        const artCtx = artCanvas.getContext('2d', { willReadFrequently: true });
        const gridCtx = gridCanvas.getContext('2d');
        const prevCtx = previewCanvas.getContext('2d');

        // --- State ---
        let width = 32, height = 32;
        let currentTool = 'pencil';
        let currentColor = '#000000';
        let isDrawing = false;
        
        // --- Init ---
        function init() {
            // –ü–∞–ª–∏—Ç—Ä–∞
            const palBox = document.getElementById('paletteBox');
            defaultPalette.forEach(c => {
                const d = document.createElement('div');
                d.className = 'color-swatch';
                d.style.backgroundColor = c;
                d.onclick = () => selectColor(c);
                palBox.appendChild(d);
            });
            
            // –•–æ—Ç–∫–µ–∏
            document.addEventListener('keydown', e => {
                if (e.target.tagName === 'INPUT') return;
                switch(e.key.toLowerCase()) {
                    case 'b': setTool('pencil'); break;
                    case 'e': setTool('eraser'); break;
                    case 'f': setTool('fill'); break;
                    case 'i': setTool('picker'); break;
                    case 'delete': clearCanvas(); break;
                }
            });

            resizeCanvas();
        }

        function resizeCanvas() {
            width = parseInt(document.getElementById('sizeX').value) || 32;
            height = parseInt(document.getElementById('sizeY').value) || 32;
            
            // CSS —Ä–∞–∑–º–µ—Ä—ã (Zoom)
            const cssW = width * ZOOM;
            const cssH = height * ZOOM;

            [artCanvas, gridCanvas].forEach(c => {
                c.width = width;
                c.height = height;
                c.style.width = cssW + 'px';
                c.style.height = cssH + 'px';
            });
            
            board.style.width = cssW + 'px';
            board.style.height = cssH + 'px';

            // –ü—Ä–µ–≤—å—é
            previewCanvas.width = width;
            previewCanvas.height = height;
            // –£–≤–µ–ª–∏—á–∏–º –ø—Ä–µ–≤—å—é –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –æ—á–µ–Ω—å –º–µ–ª–∫–∞—è
            const prevScale = width < 16 ? 4 : (width < 32 ? 2 : 1);
            previewCanvas.style.width = (width * prevScale) + 'px';
            previewCanvas.style.height = (height * prevScale) + 'px';

            drawGrid();
            updatePreview();
        }

        // --- Grid ---
        function drawGrid() {
            gridCtx.clearRect(0, 0, width, height);
            if (!document.getElementById('showGrid').checked) return;

            gridCtx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            gridCtx.lineWidth = 0.05; 

            gridCtx.beginPath();
            for (let x = 0; x <= width; x++) {
                gridCtx.moveTo(x, 0); gridCtx.lineTo(x, height);
            }
            for (let y = 0; y <= height; y++) {
                gridCtx.moveTo(0, y); gridCtx.lineTo(width, y);
            }
            gridCtx.stroke();
        }

        // --- Tools ---
        function selectColor(hex) {
            currentColor = hex;
            document.getElementById('colorPicker').value = hex;
            if (currentTool === 'eraser') setTool('pencil');
        }
        document.getElementById('colorPicker').addEventListener('input', e => selectColor(e.target.value));

        function setTool(t) {
            currentTool = t;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`[onclick="setTool('${t}')"]`);
            if(btn) btn.classList.add('active');
            
            // –ú–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä –Ω–∞ artCanvas
            artCanvas.style.cursor = t === 'picker' ? 'alias' : (t === 'fill' ? 'cell' : 'crosshair');
        }

        // --- Drawing Logic ---
        function getCoords(e) {
            const rect = artCanvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / ZOOM);
            const y = Math.floor((e.clientY - rect.top) / ZOOM);
            return {x, y};
        }

        function drawPixel(x, y) {
            if (x < 0 || y < 0 || x >= width || y >= height) return;
            
            // –ï—Å–ª–∏ –ª–∞—Å—Ç–∏–∫ - –æ—á–∏—â–∞–µ–º (–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å), –∏–Ω–∞—á–µ —Ä–∏—Å—É–µ–º —Ü–≤–µ—Ç
            if (currentTool === 'eraser') {
                artCtx.clearRect(x, y, 1, 1);
            } else {
                artCtx.fillStyle = currentColor;
                artCtx.fillRect(x, y, 1, 1);
            }
        }

        function pickColor(x, y) {
            const data = artCtx.getImageData(x, y, 1, 1).data;
            if (data[3] === 0) return; // –ù–µ –ø–∏–∫–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π
            
            const hex = "#" + ((1 << 24) + (data[0] << 16) + (data[1] << 8) + data[2]).toString(16).slice(1);
            selectColor(hex);
            setTool('pencil');
        }

        function floodFill(startX, startY) {
            // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–ª–∏–≤–∫–∞
            const imgData = artCtx.getImageData(0, 0, width, height);
            const data = imgData.data;
            
            // –¶–≤–µ—Ç —Å—Ç–∞—Ä—Ç–∞
            const startPos = (startY * width + startX) * 4;
            const sr = data[startPos], sg = data[startPos+1], sb = data[startPos+2], sa = data[startPos+3];

            // –¶–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ (–ø–∞—Ä—Å–∏–º hex)
            let tr, tg, tb, ta;
            if (currentTool === 'eraser') {
                tr=0; tg=0; tb=0; ta=0;
            } else {
                const bigint = parseInt(currentColor.slice(1), 16);
                tr = (bigint >> 16) & 255;
                tg = (bigint >> 8) & 255;
                tb = bigint & 255;
                ta = 255;
            }

            // –ï—Å–ª–∏ —Ü–≤–µ—Ç–∞ —Å–æ–≤–ø–∞–¥–∞—é—Ç, –≤—ã—Ö–æ–¥–∏–º
            if (sr===tr && sg===tg && sb===tb && sa===ta) return;

            const stack = [[startX, startY]];
            
            while (stack.length) {
                const [x, y] = stack.pop();
                const pos = (y * width + x) * 4;

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü –∏ —Ü–≤–µ—Ç–∞
                if (x < 0 || x >= width || y < 0 || y >= height) continue;
                if (data[pos] !== sr || data[pos+1] !== sg || data[pos+2] !== sb || data[pos+3] !== sa) continue;

                // –ö—Ä–∞—Å–∏–º
                data[pos] = tr; data[pos+1] = tg; data[pos+2] = tb; data[pos+3] = ta;

                stack.push([x+1, y], [x-1, y], [x, y+1], [x, y-1]);
            }
            artCtx.putImageData(imgData, 0, 0);
        }

        // --- Mouse Events (–°–ª—É—à–∞–µ–º —Ç–æ–ª—å–∫–æ artCanvas!) ---
        artCanvas.addEventListener('mousedown', e => {
            if (e.button !== 0) return;
            const p = getCoords(e);
            
            if (currentTool === 'picker') pickColor(p.x, p.y);
            else if (currentTool === 'fill') { floodFill(p.x, p.y); updatePreview(); }
            else { isDrawing = true; drawPixel(p.x, p.y); updatePreview(); }
        });

        window.addEventListener('mouseup', () => isDrawing = false);
        
        artCanvas.addEventListener('mousemove', e => {
            if (!isDrawing) return;
            const p = getCoords(e);
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã –≤—Å–µ –µ—â–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ç–æ–≥–æ –∂–µ –ø–∏–∫—Å–µ–ª—è, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            drawPixel(p.x, p.y);
            // updatePreview(); // –î–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ mouseup
        });
        
        artCanvas.addEventListener('mouseup', updatePreview); // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –æ—Ç–ø—É—Å—Ç–∏–ª–∏ –º—ã—à—å

        function updatePreview() {
            prevCtx.clearRect(0, 0, width, height);
            prevCtx.drawImage(artCanvas, 0, 0);
        }

        function clearCanvas() {
            if(confirm('–°—Ç–µ—Ä–µ—Ç—å –≤—Å—ë?')) {
                artCtx.clearRect(0, 0, width, height);
                updatePreview();
            }
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = `sprite_${Date.now()}.png`;
            link.href = artCanvas.toDataURL('image/png');
            link.click();
        }

        init();
    </script>
</body>
</html>
